<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Pressed Latinum - Portfolio Dashboard</title>
    
    <!-- Modern Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- Hidden SVG Icon Library -->
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <!-- Refresh Icon -->
            <symbol id="icon-refresh" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
            </symbol>
            
            <!-- Chart/Analytics Icon -->
            <symbol id="icon-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
            </symbol>
            
            <!-- Trending Up Icon -->
            <symbol id="icon-trending-up" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                <polyline points="17 6 23 6 23 12"/>
            </symbol>
            
            <!-- Trending Down Icon -->
            <symbol id="icon-trending-down" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/>
                <polyline points="17 18 23 18 23 12"/>
            </symbol>
            
            <!-- Dollar Sign Icon -->
            <symbol id="icon-dollar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </symbol>
            
            <!-- Info Icon -->
            <symbol id="icon-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
            </symbol>
            
            <!-- Alert/Warning Icon -->
            <symbol id="icon-alert" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </symbol>
            
            <!-- Portfolio/Briefcase Icon -->
            <symbol id="icon-portfolio" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
            </symbol>
            
            <!-- Shield/Risk Icon -->
            <symbol id="icon-shield" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </symbol>
            
            <!-- Target Icon -->
            <symbol id="icon-target" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="6"/>
                <circle cx="12" cy="12" r="2"/>
            </symbol>
            
            <!-- Options Icon -->
            <symbol id="icon-options" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 20h9"/>
                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
            </symbol>
            
            <!-- News Icon -->
            <symbol id="icon-news" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/>
                <line x1="10" y1="10" x2="18" y2="10"/>
                <line x1="10" y1="14" x2="18" y2="14"/>
                <line x1="10" y1="18" x2="14" y2="18"/>
            </symbol>
            
            <!-- Social Icon -->
            <symbol id="icon-social" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
            </symbol>
            
            <!-- Lightbulb/Idea Icon -->
            <symbol id="icon-lightbulb" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 18h6"/>
                <path d="M10 22h4"/>
                <path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/>
            </symbol>
            
            <!-- Check/Success Icon -->
            <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"/>
            </symbol>
            
            <!-- X/Close Icon -->
            <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </symbol>
            
            <!-- Activity/Pulse Icon -->
            <symbol id="icon-activity" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
            </symbol>
            
            <!-- Pie Chart Icon -->
            <symbol id="icon-pie-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                <path d="M22 12A10 10 0 0 0 12 2v10z"/>
            </symbol>
            
            <!-- Calendar Icon -->
            <symbol id="icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </symbol>
            
            <!-- Zap/Lightning Icon -->
            <symbol id="icon-zap" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </symbol>
            
            <!-- Filter Icon -->
            <symbol id="icon-filter" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
            </symbol>
            
            <!-- Settings Icon -->
            <symbol id="icon-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 1v6m0 6v6m5.2-17.4l-3 5.2m-4.4 7.6l-3 5.2M23 12h-6m-6 0H5m17.4-5.2l-5.2 3m-7.6 4.4l-5.2 3"/>
            </symbol>
            
            <!-- Technical Analysis Icon -->
            <symbol id="icon-technical" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 3v18h18"/>
                <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
            </symbol>
            
            <!-- Metrics Icon -->
            <symbol id="icon-metrics" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <path d="M9 9h6v6H9z"/>
                <path d="M9 1v6"/>
                <path d="M15 1v6"/>
                <path d="M9 17v6"/>
                <path d="M15 17v6"/>
            </symbol>
            
            <!-- Resistance Icon -->
            <symbol id="icon-resistance" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                <path d="M8 12l2 2 4-4"/>
            </symbol>
            
            <!-- Volatility Icon -->
            <symbol id="icon-volatility" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
            </symbol>
            
            <!-- Greeks Icon -->
            <symbol id="icon-greeks" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                <path d="M8 12l2 2 4-4"/>
                <circle cx="12" cy="12" r="1"/>
            </symbol>
        </defs>
    </svg>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Modern Color Palette */
            --primary-blue: #0F172A;
            --primary-blue-light: #1E293B;
            --primary-blue-lighter: #334155;
            --accent-gold: #F59E0B;
            --accent-gold-light: #FCD34D;
            --accent-emerald: #10B981;
            --accent-red: #EF4444;
            --bg-primary: #F8FAFC;
            --bg-secondary: #F1F5F9;
            --bg-card: #FFFFFF;
            --text-primary: #0F172A;
            --text-secondary: #64748B;
            --text-muted: #94A3B8;
            --border-color: #E2E8F0;
            --shadow-sm: 0 1px 3px rgba(15, 23, 42, 0.08);
            --shadow-md: 0 4px 6px -1px rgba(15, 23, 42, 0.08), 0 2px 4px -1px rgba(15, 23, 42, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(15, 23, 42, 0.08), 0 4px 6px -2px rgba(15, 23, 42, 0.04);
            --shadow-xl: 0 20px 25px -5px rgba(15, 23, 42, 0.08), 0 10px 10px -5px rgba(15, 23, 42, 0.04);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            font-size: 15px;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', 'Inter', sans-serif;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        /* Icon System */
        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            stroke-width: 2;
            fill: none;
            vertical-align: middle;
        }

        .icon-sm { width: 16px; height: 16px; }
        .icon-md { width: 20px; height: 20px; }
        .icon-lg { width: 24px; height: 24px; }
        .icon-xl { width: 32px; height: 32px; }
        .icon-2xl { width: 48px; height: 48px; }

        .icon-inline {
            margin-right: 0.5rem;
            vertical-align: -0.15em;
        }

        .icon-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            color: white;
            padding: 1.5rem 2.5rem;
            box-shadow: var(--shadow-lg);
            border-bottom: 3px solid var(--accent-gold);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(245, 158, 11, 0.05) 50%, transparent 70%);
            pointer-events: none;
        }

        .header h1 {
            font-size: 2.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 1rem;
            letter-spacing: -0.03em;
            position: relative;
            z-index: 1;
        }

        .logo {
            width: 52px;
            height: 52px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: rotate(360deg) scale(1.1);
        }


        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .refresh-button {
            position: fixed;
            top: 24px;
            right: 24px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            color: white;
            border: 2px solid var(--accent-gold);
            padding: 14px 18px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3rem;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .refresh-button:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: var(--shadow-xl);
            background: linear-gradient(135deg, var(--primary-blue-light) 0%, var(--primary-blue-lighter) 100%);
            border-color: var(--accent-gold-light);
        }

        .refresh-button:active {
            transform: scale(0.95) rotate(90deg);
        }

        .status-indicator {
            position: fixed;
            top: 24px;
            right: 92px;
            padding: 10px 16px;
            border-radius: 24px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            backdrop-filter: blur(10px);
            letter-spacing: 0.025em;
            text-transform: uppercase;
            box-shadow: var(--shadow-md);
        }

        .status-online {
            background: linear-gradient(135deg, var(--accent-emerald) 0%, #059669 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .status-offline {
            background: linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--primary-blue-lighter) 0%, var(--primary-blue-light) 100%);
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            line-height: 20px;
            margin-left: 6px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
            border: 2px solid transparent;
        }

        .tooltip-icon:hover {
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%);
            transform: scale(1.15);
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-md);
        }

        .tooltip-content {
            display: none;
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            color: white;
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            width: 340px;
            z-index: 1000;
            border: 2px solid var(--accent-gold);
            backdrop-filter: blur(10px);
        }

        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 10px solid transparent;
            border-top-color: var(--accent-gold);
        }

        .tooltip-container:hover .tooltip-content {
            display: block;
            animation: tooltipFadeIn 0.2s ease-out;
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .tooltip-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.05rem;
            margin-bottom: 0.6rem;
            color: var(--accent-gold-light);
            letter-spacing: -0.01em;
        }

        .tooltip-description {
            font-size: 0.875rem;
            line-height: 1.5;
            margin-bottom: 0.75rem;
            color: rgba(255, 255, 255, 0.95);
        }

        .tooltip-example {
            background: rgba(255,255,255,0.08);
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.8rem;
            margin-top: 0.6rem;
            border-left: 3px solid var(--accent-gold);
            backdrop-filter: blur(5px);
        }

        .tooltip-example-title {
            font-weight: 700;
            color: var(--accent-gold-light);
            margin-bottom: 0.35rem;
            font-size: 0.85rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--accent-gold);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-gold) 0%, var(--accent-gold-light) 50%, var(--accent-gold) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--accent-gold);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card h3 {
            font-family: 'Poppins', sans-serif;
            color: var(--text-primary);
            margin-bottom: 1.25rem;
            font-size: 1.25rem;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.75rem;
            letter-spacing: -0.02em;
            position: relative;
        }

        .card h3::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%);
        }

        .risk-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .metric {
            text-align: center;
            padding: 1.25rem;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            border-radius: 12px;
            border-left: 4px solid var(--accent-gold);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .metric:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-left-color: var(--accent-gold-light);
        }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            letter-spacing: -0.02em;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .positive { color: var(--accent-emerald); }
        .negative { color: var(--accent-red); }
        .neutral { color: var(--accent-gold); }

        .portfolio-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .portfolio-main-metrics {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }

        .main-metric {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            color: white;
            border-radius: 20px;
            min-width: 160px;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--accent-gold);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .main-metric::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.05) 50%, transparent 70%);
            transform: rotate(45deg);
            pointer-events: none;
        }

        .main-metric:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-xl);
            border-color: var(--accent-gold-light);
        }

        .main-value {
            font-size: 2.25rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            font-family: 'Poppins', sans-serif;
            letter-spacing: -0.03em;
            position: relative;
            z-index: 1;
        }

        .main-label {
            font-size: 0.85rem;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .portfolio-details {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-width: 120px;
        }

        .detail-row.csp-cash-row {
            background: transparent;
            padding: 0.75rem;
            border-radius: 10px;
            border-left: none;
            margin-top: 0;
        }

        .detail-row.csp-cash-row .detail-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .detail-row.csp-cash-row .detail-value {
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
        }

        /* Position type badges */
        .position-type {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.075em;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .position-type:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .position-type.call {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            color: white;
            border: 2px solid var(--accent-gold);
        }

        .position-type.put {
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%);
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
        }

        /* Filter section styling */
        .filters-section {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-primary) 100%) !important;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .filters-section h4 {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .form-group label {
            color: var(--text-primary) !important;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-group input,
        .form-group select {
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 10px;
            padding: 0.65rem 1rem;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
            outline: none;
            background: white;
        }

        .form-group input:hover,
        .form-group select:hover {
            border-color: var(--accent-gold);
        }

        /* Table improvements */
        table {
            font-size: 0.9rem;
        }

        th, td {
            padding: 0.6rem;
            font-size: 0.85rem;
        }

        /* Greeks columns styling */
        td:nth-child(11), td:nth-child(12), td:nth-child(13), td:nth-child(14), td:nth-child(15) {
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }

        th:nth-child(11), th:nth-child(12), th:nth-child(13), th:nth-child(14), th:nth-child(15) {
            text-align: center;
            font-size: 0.8rem;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-secondary);
            margin-right: 0.5rem;
            font-size: 0.9rem;
        }

        .detail-value {
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
        }

        .summary-item {
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            border-radius: 16px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: var(--shadow-sm);
        }

        .summary-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-gold);
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            letter-spacing: -0.02em;
        }

        .summary-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .positions-table {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1rem;
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        th, td {
            padding: 1rem 0.875rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            font-weight: 700;
            color: white;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: 'Poppins', sans-serif;
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background-color: var(--bg-primary);
            transform: scale(1.01);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            color: white;
            border: 2px solid var(--accent-gold);
            padding: 0.875rem 1.75rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0.25rem;
            box-shadow: var(--shadow-md);
            letter-spacing: 0.025em;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
            background: linear-gradient(135deg, var(--primary-blue-light) 0%, var(--primary-blue-lighter) 100%);
            border-color: var(--accent-gold-light);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-emerald) 0%, #059669 100%);
            border-color: white;
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            border-color: #f4e04d;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
            border-color: white;
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        /* Compact button styling for table actions */
        .compact-btn {
            padding: 0.4rem 0.6rem !important;
            font-size: 0.75rem !important;
            min-width: auto !important;
            width: auto !important;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            animation: modalFadeIn 0.2s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-card);
            margin: 5% auto;
            padding: 2.5rem;
            border-radius: 20px;
            width: 90%;
            max-width: 520px;
            box-shadow: var(--shadow-xl);
            border: 2px solid var(--accent-gold);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close {
            color: var(--text-muted);
            float: right;
            font-size: 32px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .close:hover {
            color: var(--accent-red);
            transform: rotate(90deg);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-primary) 100%);
            border-radius: 20px;
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-lg);
        }
        
        .loading-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .loading-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.5rem;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
        }
        
        .spinner {
            width: 36px;
            height: 36px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-container {
            margin-bottom: 1.5rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 0.75rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%);
            border-radius: 8px;
            transition: width 0.3s ease;
            width: 0%;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        .progress-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .loading-details {
            text-align: left;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .loading-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .loading-item:last-child {
            border-bottom: none;
        }
        
        .loading-icon {
            font-size: 1.25rem;
            min-width: 24px;
        }
        
        .loading-text {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .loading-item.active {
            color: #3b82f6;
        }
        
        .loading-item.active .loading-text {
            color: #3b82f6;
            font-weight: 600;
        }
        
        .loading-item.completed {
            color: #059669;
        }
        
        .loading-item.completed .loading-text {
            color: #059669;
        }
        
        .loading-item.error {
            color: #dc2626;
        }
        
        .loading-item.error .loading-text {
            color: #dc2626;
        }

        .loading-step.active {
            border-left-color: #1e3a8a;
            background: #f0f4ff;
        }

        .loading-step.completed {
            border-left-color: #059669;
            background: #f0fdf4;
        }

        /* Duplicate spinner removed - using main spinner definition above */

        .error {
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
            color: #991B1B;
            padding: 1.25rem 1.5rem;
            border-radius: 12px;
            margin: 1rem 0;
            border-left: 4px solid var(--accent-red);
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }

        .success {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            color: #065F46;
            padding: 1.25rem 1.5rem;
            border-radius: 12px;
            margin: 1rem 0;
            border-left: 4px solid var(--accent-emerald);
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .risk-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .container {
                padding: 1rem;
            }
        }

        /* Prevent horizontal overflow */
        * {
            box-sizing: border-box;
        }

        body {
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            overflow-x: hidden;
        }

        .card {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Ensure tables are responsive */
        .positions-table {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            min-width: 100%;
            table-layout: auto;
        }

        /* Responsive text sizing */
        @media (max-width: 480px) {
            .component-label {
                font-size: 0.7rem;
            }
            
            .component-value {
                font-size: 0.6rem;
            }
            
            .score-component {
                gap: 0.1rem;
            }
        }

        /* Greeks metric cards */
        .metric-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-primary) 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-gold);
        }

        .metric-label {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: #1e3a8a;
        }

        .metric-value.positive {
            color: #1e3a8a;
        }

        .metric-value.negative {
            color: #d4af37;
        }
        
        .metric-value.info {
            color: #3b82f6;
        }

        .metric-description {
            font-size: 0.8rem;
            color: #64748b;
            font-style: italic;
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            padding: 0;
            margin: 0;
            display: flex;
            border-bottom: 3px solid var(--accent-gold);
            box-shadow: var(--shadow-md);
            border-radius: 16px 16px 0 0;
            overflow: hidden;
        }

        .tab-button {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            padding: 1.25rem 2rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 4px solid transparent;
            flex: 1;
            text-align: center;
            position: relative;
            letter-spacing: 0.025em;
        }

        .tab-button::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-gold);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--accent-gold-light);
        }

        .tab-button:hover::before {
            transform: scaleX(1);
        }

        .tab-button.active {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-gold-light);
            font-weight: 700;
        }

        .tab-button.active::before {
            transform: scaleX(1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Recommendation Card Styles */
        .recommendation-card {
            margin-bottom: 2rem;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .recommendation-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-xl);
            border-color: var(--accent-gold);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
            color: white;
            padding: 2rem;
            border-bottom: none;
            position: relative;
            overflow: hidden;
        }

        .card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.05) 50%, transparent 70%);
            pointer-events: none;
        }

        .card-header h4 {
            margin: 0 0 0.75rem 0;
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            position: relative;
            z-index: 1;
        }

        .card-subtitle {
            margin: 0;
            opacity: 0.95;
            font-size: 0.95rem;
            font-weight: 400;
            position: relative;
            z-index: 1;
        }

        .card-content {
            padding: 2rem;
            background: var(--bg-card);
        }

        .recommendation-controls {
            margin-bottom: 1.5rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
        }
        
        .ticker-memory-section {
            width: 100%;
        }
        
        .ticker-memory-section label {
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        .ticker-memory-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .ticker-chip {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--border-color);
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .ticker-chip::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .ticker-chip:hover::before {
            left: 100%;
        }
        
        .ticker-chip:hover {
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%);
            color: var(--primary-blue);
            border-color: var(--primary-blue);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .ticker-chip:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .ticker-chip-icon {
            width: 12px;
            height: 12px;
            stroke: currentColor;
        }

        /* Different chip styles for different search types */
        .ticker-chip[data-type="csp"] {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-color: #0ea5e9;
            color: #0c4a6e;
        }

        .ticker-chip[data-type="csp"]:hover {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
        }

        .ticker-chip[data-type="stock"] {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #22c55e;
            color: #166534;
        }

        .ticker-chip[data-type="stock"]:hover {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .ticker-chip[data-type="market"] {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
            color: #92400e;
        }

        .ticker-chip[data-type="market"]:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .no-memory {
            color: #94a3b8;
            font-style: italic;
            font-size: 0.875rem;
        }
        
        .memory-actions {
            margin-top: 0.5rem;
        }

        .input-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .btn-large {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-icon {
            font-size: 1.1rem;
        }

        .control-description {
            margin: 0;
            color: #6b7280;
            font-size: 0.85rem;
            font-style: italic;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .table-header h5 {
            margin: 0;
            color: #1f2937;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .table-info {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .recommendations-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .recommendations-table th {
            background: #f8fafc;
            color: #374151;
            font-weight: 600;
            padding: 0.75rem 0.5rem;
            text-align: left;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
        }

        .recommendations-table td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #f3f4f6;
            white-space: nowrap;
        }

        .recommendations-table tbody tr:hover {
            background: #f8fafc;
        }

        .score {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .positive {
            color: #059669;
            font-weight: 600;
        }

        .negative {
            color: #dc2626;
            font-weight: 600;
        }

        /* Expandable row styles */
        .expand-icon {
            display: inline-block;
            font-size: 0.8rem;
            transition: transform 0.2s;
        }

        .cc-main-row:hover {
            background: #f1f5f9 !important;
        }

        .cc-detail-row {
            background: #f8fafc;
        }

        .row-detail-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .detail-section {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            background: white;
        }

        .detail-section h5 {
            margin: 0 0 1rem 0;
            color: #1f2937;
            font-size: 1rem;
            font-weight: 600;
        }

        .score-components-inline {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            .score-components-inline {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .score-components-inline {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }
        }

        .score-component {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .component-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #6b7280;
            line-height: 1.2;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .component-bar {
            height: 16px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.25rem 0;
        }

        .component-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .component-value {
            font-size: 0.7rem;
            color: #6b7280;
            line-height: 1.2;
            word-wrap: break-word;
        }

        @media (max-width: 768px) {
            .component-label {
                font-size: 0.75rem;
            }
            
            .component-value {
                font-size: 0.65rem;
            }
            
            .component-bar {
                height: 14px;
            }
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            font-size: 0.9rem;
            width: 100%;
            max-width: 100%;
        }

        @media (max-width: 768px) {
            .details-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
                font-size: 0.85rem;
            }
        }

        .details-grid div {
            padding: 0.5rem;
            background: #f9fafb;
            border-radius: 4px;
        }

        /* Modal Score Breakdown Styles */
        .score-breakdown-container {
            max-width: 100%;
            overflow-x: hidden;
        }

        .score-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .score-total {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-top: 0.5rem;
        }

        .score-large {
            font-size: 1.5rem;
            color: var(--accent-gold);
        }

        .score-components {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .score-component {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .score-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .score-bar-container {
            width: 100%;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .score-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .score-value {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .score-breakdown-container {
                padding: 0.5rem;
            }
            
            .score-component {
                padding: 0.75rem;
                gap: 0.25rem;
            }
            
            .score-label {
                font-size: 0.8rem;
            }
            
            .score-value {
                font-size: 0.7rem;
            }
            
            .score-bar-container {
                height: 16px;
            }
        }

        /* Risk Dashboard Styles */
        .risk-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .risk-controls .btn {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: #f8fafc;
            border: 1px solid #d4af37;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .risk-controls .btn:hover {
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
        }

        .risk-metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .risk-metric-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-primary) 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
        }

        .risk-metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-gold);
        }

        .risk-metric-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .risk-metric-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-family: 'Poppins', sans-serif;
            letter-spacing: -0.02em;
        }

        .risk-metric-value.positive {
            color: var(--accent-emerald);
        }

        .risk-metric-value.negative {
            color: var(--accent-red);
        }

        .risk-metric-value.warning {
            color: var(--accent-gold);
        }

        .risk-metric-value.info {
            color: var(--primary-blue-lighter);
        }

        .stress-test-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            margin: 1rem 0;
        }

        .stress-test-scenario {
            background: #fefefe;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .stress-test-scenario:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stress-test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .stress-test-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1e3a8a;
            margin: 0;
        }

        .stress-test-severity {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-low {
            background: #d1fae5;
            color: #065f46;
        }

        .severity-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .severity-high {
            background: #fee2e2;
            color: #991b1b;
        }

        .stress-test-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .stress-test-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stress-test-metric {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #1e3a8a;
        }

        .stress-test-metric-label {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .stress-test-metric-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e3a8a;
        }

        .stress-test-metric-value.positive {
            color: #059669;
        }

        .stress-test-metric-value.negative {
            color: #dc2626;
        }

        .stress-test-metric-value.warning {
            color: #d97706;
        }

        .stress-test-explanation {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .explanation-section {
            margin-bottom: 1rem;
        }

        .explanation-section:last-child {
            margin-bottom: 0;
        }

        .explanation-label {
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .explanation-text {
            color: #4b5563;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .stress-test-chart {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #fefefe;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 1rem;
            text-align: center;
        }

        .scenario-chart {
            width: 100%;
            height: 200px;
        }

        @media (max-width: 768px) {
            .stress-test-content {
                grid-template-columns: 1fr;
            }
            
            .stress-test-metrics {
                grid-template-columns: 1fr;
            }
        }

        /* Stock Analysis Tab Styles */
        .analysis-controls {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .search-section {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            color: #1e3a8a;
        }

        .search-input:focus {
            outline: none;
            border-color: #1e3a8a;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }

        .analysis-filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: #fefefe;
            color: #1e3a8a;
            font-size: 0.9rem;
            min-width: 150px;
        }

        .scanner-controls {
            margin-bottom: 2rem;
        }

        .scanner-filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .placeholder-content {
            text-align: center;
            padding: 3rem 2rem;
            color: #64748b;
        }

        .placeholder-icon {
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .placeholder-icon svg {
            width: 64px;
            height: 64px;
            stroke: var(--text-muted);
            opacity: 0.6;
        }

        .placeholder-content h4 {
            color: #1e3a8a;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .feature-list {
            list-style: none;
            padding: 0;
            margin: 1.5rem 0;
            text-align: left;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .feature-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .feature-list li:last-child {
            border-bottom: none;
        }

        /* Social Media Tab Styles */
        .social-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .platform-selection h4,
        .content-settings h4 {
            color: #1e3a8a;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .platform-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .platform-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #fefefe;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .platform-option:hover {
            background: #f1f5f9;
            border-color: #1e3a8a;
        }

        .platform-option input[type="checkbox"] {
            margin: 0;
        }

        .platform-icon {
            font-size: 1.2rem;
        }

        .setting-group {
            margin-bottom: 1rem;
        }

        .setting-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #1e3a8a;
            font-weight: 500;
        }

        .social-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .template-controls {
            margin-bottom: 2rem;
        }

        .template-categories {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .template-category {
            padding: 0.75rem 1.5rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .template-category:hover {
            background: #f1f5f9;
            color: #1e3a8a;
        }

        .template-category.active {
            background: #1e3a8a;
            color: #f8fafc;
            border-color: #1e3a8a;
        }

        @media (max-width: 768px) {
            .social-controls {
                grid-template-columns: 1fr;
            }
            
            .analysis-filters {
                flex-direction: column;
            }
            
            .scanner-filters {
                flex-direction: column;
            }
            
            .social-actions {
                flex-direction: column;
            }
        }

        .chart-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .chart-controls .btn {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: #f8fafc;
            border: 1px solid #d4af37;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .chart-controls select {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: #fefefe;
            color: #1e3a8a;
            font-size: 0.9rem;
        }

        #risk-charts {
            margin: 1rem 0;
        }

        #riskChart {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #fefefe;
            max-width: 100%;
            height: 400px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <svg class="logo" id="current-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <!-- Default: Latinum bars -->
                <rect x="20" y="30" width="60" height="40" fill="#d4af37" stroke="#1e3a8a" stroke-width="2" rx="4"/>
                <rect x="25" y="35" width="50" height="8" fill="#f4d03f" rx="2"/>
                <rect x="25" y="47" width="50" height="8" fill="#f4d03f" rx="2"/>
                <rect x="25" y="59" width="50" height="8" fill="#f4d03f" rx="2"/>
                <text x="50" y="85" text-anchor="middle" font-family="Arial" font-size="8" fill="#1e3a8a">LATINUM</text>
            </svg>
            Gold Pressed Latinum
        </h1>
    </div>


    <!-- Refresh Button and Status -->
    <button class="refresh-button" onclick="refreshDashboard()" title="Refresh Data">
        <svg class="icon icon-lg" style="width: 24px; height: 24px;">
            <use href="#icon-refresh"/>
        </svg>
    </button>
    <div id="status-indicator" class="status-indicator status-online">
        <span id="status-text">Online</span>
    </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active icon-button" onclick="switchTab('overview')" id="tab-overview">
                <svg class="icon icon-md">
                    <use href="#icon-portfolio"/>
                </svg>
                Portfolio Overview
            </button>
            <button class="tab-button icon-button" onclick="switchTab('risk')" id="tab-risk">
                <svg class="icon icon-md">
                    <use href="#icon-shield"/>
                </svg>
                Risk Monitoring
            </button>
            <button class="tab-button icon-button" onclick="switchTab('options')" id="tab-options">
                <svg class="icon icon-md">
                    <use href="#icon-target"/>
                </svg>
                Option Selection
            </button>
            <button class="tab-button icon-button" onclick="switchTab('analysis')" id="tab-analysis">
                <svg class="icon icon-md">
                    <use href="#icon-chart"/>
                </svg>
                Stock Analysis
            </button>
            <button class="tab-button icon-button" onclick="switchTab('social')" id="tab-social">
                <svg class="icon icon-md">
                    <use href="#icon-social"/>
                </svg>
                Social Media
            </button>
        </div>

    <div class="container">
        <!-- Portfolio Overview Tab -->
        <div id="overview-tab" class="tab-content active">
        <!-- Loading Progress (Hidden after load) -->
        <div class="card" id="loadingContainer">
            <h3>
                <svg class="icon icon-md icon-inline" style="stroke: var(--accent-gold); animation: spin 2s linear infinite;">
                    <use href="#icon-refresh"/>
                </svg>
                Loading Portfolio Dashboard
            </h3>
            <div class="loading-progress">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Initializing...</div>
                </div>
                <div class="loading-details" id="loadingDetails">
                    <div class="loading-item" id="loadingItem1">
                        <span class="loading-icon">â³</span>
                        <span class="loading-text">Connecting to database...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Overview -->
        <div class="card">
            <h3>
                <svg class="icon icon-md icon-inline" style="stroke: var(--primary-blue);">
                    <use href="#icon-pie-chart"/>
                </svg>
                Portfolio Overview
            </h3>
            <div class="portfolio-summary" id="portfolio-summary">
                <div class="loading">Loading portfolio data...</div>
            </div>
        </div>

        <!-- Stock Holdings -->
        <div class="card">
            <h3>
                <svg class="icon icon-md icon-inline" style="stroke: var(--accent-emerald);">
                    <use href="#icon-trending-up"/>
                </svg>
                Stock Holdings
            </h3>
            <div class="risk-metrics" id="stock-metrics">
                <div class="loading">Loading stock data...</div>
            </div>
        </div>

        <!-- Options Holdings -->
        <div class="card">
            <h3>
                <svg class="icon icon-md icon-inline" style="stroke: var(--accent-gold);">
                    <use href="#icon-target"/>
                </svg>
                Options Holdings
            </h3>
            <div class="risk-metrics" id="options-metrics">
                <div class="loading">Loading options data...</div>
            </div>
        </div>

        <!-- Portfolio Greeks -->
        <div class="card">
            <h3>
                <svg class="icon icon-md icon-inline" style="stroke: var(--primary-blue-lighter);">
                    <use href="#icon-activity"/>
                </svg>
                Portfolio Greeks
            </h3>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                Portfolio Greeks exposure - Total (portfolio-wide) and Average (per position)
            </p>
            <div id="greeks-display" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                <div class="loading">Loading Greeks data...</div>
            </div>
        </div>

        <!-- Concentration Risk -->
        <div class="card">
            <h3>
                <svg class="icon icon-md icon-inline" style="stroke: var(--accent-gold);">
                    <use href="#icon-pie-chart"/>
                </svg>
                Concentration Analysis
            </h3>
            <div id="concentration-analysis">
                <div class="loading">Loading concentration data...</div>
            </div>
        </div>

        <!-- Positions Table -->
        <div class="card">
            <h3>
                <svg class="icon icon-md icon-inline" style="stroke: var(--primary-blue);">
                    <use href="#icon-portfolio"/>
                </svg>
                Portfolio Positions
            </h3>
            <div style="margin-bottom: 1rem;">
                <button class="btn icon-button" onclick="openAddPositionModal()">
                    <svg class="icon icon-sm">
                        <use href="#icon-trending-up"/>
                    </svg>
                    Add Position
                </button>
                <button class="btn btn-success icon-button" onclick="exportPortfolio()">
                    <svg class="icon icon-sm">
                        <use href="#icon-check"/>
                    </svg>
                    Export CSV
                </button>
                <input type="file" id="import-file" accept=".csv" style="display: none;" onchange="importPortfolio()">
                <button class="btn icon-button" onclick="document.getElementById('import-file').click()">
                    <svg class="icon icon-sm">
                        <use href="#icon-filter"/>
                    </svg>
                    Import CSV
                </button>
            </div>
            
            <!-- Filters -->
            <div class="filters-section" style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <!-- Stock Filters -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: #1e3a8a; margin-bottom: 1rem; font-size: 1rem; font-weight: 600;">ðŸ“ˆ Stock Filters</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="form-group">
                            <label for="stock-ticker-filter">Ticker:</label>
                            <input type="text" id="stock-ticker-filter" placeholder="Enter ticker symbol..." onkeyup="filterPositions()">
                        </div>
                        <div class="form-group">
                            <label for="stock-sort-by">Sort by:</label>
                            <select id="stock-sort-by" onchange="sortPositions()">
                                <option value="ticker">Ticker</option>
                                <option value="quantity">Quantity</option>
                                <option value="pnl">P&L</option>
                                <option value="pnl_pct">P&L %</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="stock-sort-order">Sort Order:</label>
                            <select id="stock-sort-order" onchange="sortPositions()">
                                <option value="asc">Ascending</option>
                                <option value="desc">Descending</option>
                            </select>
                        </div>
                    </div>
                </div>


                <!-- Quick Actions -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn icon-button" onclick="clearFilters()">
                            <svg class="icon icon-sm">
                                <use href="#icon-x"/>
                            </svg>
                            Clear All Filters
                        </button>
                        <button class="btn icon-button" onclick="showAllPositions()">
                            <svg class="icon icon-sm">
                                <use href="#icon-portfolio"/>
                            </svg>
                            Show All
                        </button>
                        <button class="btn icon-button" onclick="showOnlyStocks()">
                            <svg class="icon icon-sm">
                                <use href="#icon-trending-up"/>
                            </svg>
                            Stocks Only
                        </button>
                        <button class="btn icon-button" onclick="showOnlyOptions()">
                            <svg class="icon icon-sm">
                                <use href="#icon-target"/>
                            </svg>
                            Options Only
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="positions-table">
                <div id="positions-table">
                    <div class="loading">Loading positions...</div>
                </div>
            </div>
        </div>

        <!-- Scenario Analysis -->
        <div class="card">
            <h3>
                <svg class="icon icon-md icon-inline" style="stroke: var(--primary-blue-lighter);">
                    <use href="#icon-chart"/>
                </svg>
                Scenario Analysis
            </h3>
            <div id="scenario-analysis">
                <p>Add a position to see scenario impact analysis</p>
            </div>
        </div>
        </div> <!-- End Overview Tab -->

        <!-- Risk Monitoring Tab -->
        <div id="risk-tab" class="tab-content">
            <div class="card">
                <h3>
                    <svg class="icon icon-md icon-inline" style="stroke: var(--accent-red);">
                        <use href="#icon-shield"/>
                    </svg>
                    Portfolio Risk Dashboard
                </h3>
                <div id="risk-overview">
                    <div class="loading">Loading risk analysis...</div>
                </div>
            </div>

            <div class="card">
                <h3>
                    <svg class="icon icon-md icon-inline" style="stroke: var(--accent-gold);">
                        <use href="#icon-alert"/>
                    </svg>
                    Risk Alerts
                </h3>
                <div id="risk-alerts">
                    <div class="loading">Loading risk alerts...</div>
                </div>
            </div>

            <div class="card">
                <h3>
                    <svg class="icon icon-md icon-inline" style="stroke: var(--accent-red);">
                        <use href="#icon-alert"/>
                    </svg>
                    Stress Test Scenarios
                </h3>
                <div class="risk-controls">
                    <button class="btn icon-button" onclick="runStressTests()">
                        <svg class="icon icon-sm">
                            <use href="#icon-activity"/>
                        </svg>
                        Run Stress Tests
                    </button>
                    <button class="btn icon-button" onclick="runMonteCarlo()">
                        <svg class="icon icon-sm">
                            <use href="#icon-chart"/>
                        </svg>
                        Monte Carlo Simulation
                    </button>
                    <button class="btn icon-button" onclick="refreshRiskData()">
                        <svg class="icon icon-sm">
                            <use href="#icon-refresh"/>
                        </svg>
                        Refresh Risk Data
                    </button>
                </div>
                <div id="stress-test-results">
                    <p>Click "Run Stress Tests" to analyze portfolio under various market conditions</p>
                </div>
            </div>

            <div class="card">
                <h3>
                    <svg class="icon icon-md icon-inline" style="stroke: var(--primary-blue-lighter);">
                        <use href="#icon-shield"/>
                    </svg>
                    Risk Metrics
                </h3>
                <div id="risk-metrics">
                    <div class="loading">Calculating risk metrics...</div>
                </div>
            </div>

            <div class="card">
                <h3>
                    <svg class="icon icon-md icon-inline" style="stroke: var(--accent-emerald);">
                        <use href="#icon-trending-up"/>
                    </svg>
                    Risk Charts
                </h3>
                <div class="chart-controls">
                    <button class="btn icon-button" onclick="updateRiskCharts()">
                        <svg class="icon icon-sm">
                            <use href="#icon-refresh"/>
                        </svg>
                        Update Charts
                    </button>
                    <select id="chartType" onchange="updateRiskCharts()">
                        <option value="var">Value at Risk</option>
                        <option value="greeks">Portfolio Greeks</option>
                        <option value="concentration">Concentration Risk</option>
                        <option value="volatility">Volatility Analysis</option>
                    </select>
                </div>
                <div id="risk-charts">
                    <canvas id="riskChart" width="800" height="400"></canvas>
                </div>
            </div>
        </div> <!-- End Risk Monitoring Tab -->

        <!-- Option Selection Tab -->
        <div id="options-tab" class="tab-content">
            <div class="card">
                <h3>
                    <svg class="icon icon-md icon-inline" style="stroke: var(--accent-gold);">
                        <use href="#icon-target"/>
                    </svg>
                    Option Selection Tool
                </h3>
                
                <!-- Strategy Analysis Section -->
                <div class="strategy-analysis" id="strategyAnalysis" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h4>
                                <svg class="icon icon-sm icon-inline">
                                    <use href="#icon-chart"/>
                                </svg>
                                Strategy Analysis
                            </h4>
                            <p class="card-subtitle">Analyze your selected options and their combined impact</p>
                        </div>
                        <div class="card-content">
                            <div class="strategy-builder">
                                <div class="selected-options" id="selectedOptions">
                                    <h5>Selected Options:</h5>
                                    <div id="selectedOptionsList"></div>
                                </div>
                                
                                <div class="strategy-metrics" id="strategyMetrics">
                                    <h5>Strategy Metrics:</h5>
                                    <div class="metrics-grid">
                                        <div class="metric-item">
                                            <label>Total Delta:</label>
                                            <span id="totalDelta">0.00</span>
                                        </div>
                                        <div class="metric-item">
                                            <label>Total Gamma:</label>
                                            <span id="totalGamma">0.00</span>
                                        </div>
                                        <div class="metric-item">
                                            <label>Total Theta:</label>
                                            <span id="totalTheta">0.00</span>
                                        </div>
                                        <div class="metric-item">
                                            <label>Total Vega:</label>
                                            <span id="totalVega">0.00</span>
                                        </div>
                                        <div class="metric-item">
                                            <label>Total Cost:</label>
                                            <span id="totalCost">$0.00</span>
                                        </div>
                                        <div class="metric-item">
                                            <label>Max Profit:</label>
                                            <span id="maxProfit">$0.00</span>
                                        </div>
                                        <div class="metric-item">
                                            <label>Max Loss:</label>
                                            <span id="maxLoss">$0.00</span>
                                        </div>
                                        <div class="metric-item">
                                            <label>Breakeven:</label>
                                            <span id="breakeven">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="strategy-actions">
                                    <button class="btn btn-primary icon-button" onclick="analyzeStrategy()">
                                        <svg class="icon icon-sm">
                                            <use href="#icon-chart"/>
                                        </svg>
                                        Analyze Strategy
                                    </button>
                                    <button class="btn btn-secondary icon-button" onclick="clearSelection()">
                                        <svg class="icon icon-sm">
                                            <use href="#icon-x"/>
                                        </svg>
                                        Clear Selection
                                    </button>
                                    <button class="btn btn-success icon-button" onclick="addToPortfolio()">
                                        <svg class="icon icon-sm">
                                            <use href="#icon-check"/>
                                        </svg>
                                        Add to Portfolio
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Covered Calls Section -->
                <div class="card recommendation-card">
                    <div class="card-header">
                        <h4>
                            <svg class="icon icon-sm icon-inline" style="stroke: var(--accent-emerald);">
                                <use href="#icon-trending-up"/>
                            </svg>
                            Covered Calls - Portfolio Analysis
                        </h4>
                        <p class="card-subtitle">Find the best covered call opportunities from your existing stock positions</p>
                    </div>
                    <div class="card-content">
                        <div class="recommendation-controls">
                            <div class="control-group">
                                <button class="btn btn-primary btn-large icon-button" onclick="loadCoveredCallRecommendations()">
                                    <svg class="icon icon-md">
                                        <use href="#icon-target"/>
                                    </svg>
                                    Analyze My Portfolio for Best CCs
                                </button>
                                <p class="control-description">Automatically finds covered call opportunities from stocks you own (excludes stocks with existing CCs)</p>
                            </div>
                        </div>
                        
                        <div class="recommendations-container" id="ccRecommendations" style="display: none;">
                            <div class="loading" id="ccLoading" style="display: none;">
                                <div class="loading-spinner"></div>
                                <p>Analyzing your portfolio for best covered calls...</p>
                            </div>
                            <div class="recommendations-table" id="ccTable" style="display: none;">
                                <div class="table-header">
                                    <h5>Top Covered Call Recommendations</h5>
                                    <div class="table-info" id="ccTableInfo"></div>
                                </div>
                                <div class="table-container">
                                    <table class="recommendations-table">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th>Ticker</th>
                                                <th>Contracts</th>
                                                <th>Stock Price</th>
                                                <th>Strike</th>
                                                <th>Premium</th>
                                                <th>Expiration</th>
                                                <th>Days</th>
                                                <th>Delta</th>
                                                <th>IV</th>
                                                <th>Max Profit</th>
                                                <th>ROI</th>
                                                <th>Ann. Return</th>
                                                <th>Prob. Profit</th>
                                                <th>Score</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ccTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cash Secured Puts Section -->
                <div class="card recommendation-card">
                    <div class="card-header">
                        <h4>
                            <svg class="icon icon-sm icon-inline" style="stroke: var(--accent-gold);">
                                <use href="#icon-trending-down"/>
                            </svg>
                            Cash Secured Puts - Custom Analysis
                        </h4>
                        <p class="card-subtitle">Find the best CSP opportunities for your specified tickers</p>
                    </div>
                    <div class="card-content">
                        <div class="recommendation-controls">
                            <div class="control-group">
                                <div class="input-group">
                                    <label for="cspTickers">Ticker Symbols:</label>
                                    <input type="text" id="cspTickers" placeholder="Enter tickers separated by commas or spaces (optional - leave empty for automatic selection)" class="search-input">
                                </div>
                                
                                <!-- Ticker Memory Section -->
                                <div class="ticker-memory-section">
                                    <label>Recent Searches:</label>
                                    <div class="ticker-memory-container" id="cspTickerMemory">
                                        <!-- Recent tickers will be populated here -->
                                    </div>
                        <div class="memory-actions">
                            <button class="btn btn-sm btn-secondary" onclick="clearCSPTickerMemory()" title="Clear all saved tickers">
                                <svg class="icon icon-sm">
                                    <use href="#icon-x"/>
                                </svg>
                                Clear History
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="debugCSPTickerMemory()" title="Debug memory format" style="margin-left: 0.5rem;">
                                <svg class="icon icon-sm">
                                    <use href="#icon-info"/>
                                </svg>
                                Debug
                            </button>
                        </div>
                                </div>
                                
                                <div class="button-group" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                    <button class="btn btn-primary btn-large icon-button" onclick="loadCSPRecommendations()">
                                        <svg class="icon icon-md">
                                            <use href="#icon-target"/>
                                        </svg>
                                        Find Best CSPs
                                    </button>
                                    <button class="btn btn-secondary btn-large icon-button" onclick="loadCSPFromWatchlist()">
                                        <svg class="icon icon-md">
                                            <use href="#icon-activity"/>
                                        </svg>
                                        Search Watchlist + Recent
                                    </button>
                                </div>
                                <p class="control-description">Analyze specific tickers for CSP opportunities, or use "Search Watchlist + Recent" to analyze popular/volatile stocks plus your recent searches</p>
                            </div>
                        </div>
                        
                        <div class="recommendations-container" id="cspRecommendations" style="display: none;">
                            <div class="loading" id="cspLoading" style="display: none;">
                                <div class="loading-spinner"></div>
                                <p>Analyzing tickers for best cash secured puts...</p>
                            </div>
                            <div class="recommendations-table" id="cspTable" style="display: none;">
                                <div class="table-header">
                                    <h5>Top Cash Secured Put Recommendations</h5>
                                    <div class="table-info" id="cspTableInfo"></div>
                                </div>
                                <div class="table-container">
                                    <table class="recommendations-table">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th>Ticker</th>
                                                <th>Stock Price</th>
                                                <th>Strike</th>
                                                <th>Premium</th>
                                                <th>Expiration</th>
                                                <th>Days</th>
                                                <th>Delta</th>
                                                <th>IV</th>
                                                <th>Max Profit</th>
                                                <th>Max Loss</th>
                                                <th>Breakeven</th>
                                                <th>Cash Required</th>
                                                <th>Ann. Return</th>
                                                <th>Prob. Profit</th>
                                                <th>Score</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="cspTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div> <!-- End Option Selection Tab -->

        <!-- Stock Analysis Tab -->
        <div id="analysis-tab" class="tab-content">
            <div class="card">
                <h3>
                    <svg class="icon icon-md icon-inline" style="stroke: var(--accent-emerald);">
                        <use href="#icon-chart"/>
                    </svg>
                    Complete Stock Analysis
                </h3>
                <div class="analysis-controls">
                    <div class="search-section">
                        <input type="text" id="stockSearch" placeholder="Enter ticker symbol (e.g., AAPL, TSLA)" class="search-input">
                        <button class="btn icon-button" onclick="analyzeStock()">
                            <svg class="icon icon-sm">
                                <use href="#icon-chart"/>
                            </svg>
                            Analyze Stock
                        </button>
                    </div>
                    
                    <!-- Stock Search History -->
                    <div class="ticker-memory-section" style="margin-top: 1rem;">
                        <label style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; display: block;">
                            <svg class="icon icon-sm icon-inline" style="stroke: var(--accent-gold);">
                                <use href="#icon-activity"/>
                            </svg>
                            Recent Stock Searches:
                        </label>
                        <div class="ticker-memory-container" id="stockSearchMemory">
                            <!-- Recent stock searches will be populated here -->
                        </div>
                        <div class="memory-actions" style="margin-top: 0.5rem;">
                            <button class="btn btn-sm btn-secondary icon-button" onclick="clearStockSearchMemory()" title="Clear all saved stock searches">
                                <svg class="icon icon-sm">
                                    <use href="#icon-x"/>
                                </svg>
                                Clear History
                            </button>
                        </div>
                    </div>
                    <div class="analysis-filters">
                        <select id="analysisType" class="filter-select">
                            <option value="comprehensive">Comprehensive Analysis</option>
                            <option value="technical">Technical Analysis</option>
                            <option value="fundamental">Fundamental Analysis</option>
                            <option value="sentiment">Sentiment Analysis</option>
                        </select>
                        <select id="timeframe" class="filter-select">
                            <option value="1d">1 Day</option>
                            <option value="5d">5 Days</option>
                            <option value="1m">1 Month</option>
                            <option value="3m">3 Months</option>
                            <option value="1y">1 Year</option>
                        </select>
                    </div>
                </div>
                <div id="stock-analysis-results">
                    <div class="placeholder-content">
                        <div class="placeholder-icon">
                            <svg class="icon icon-2xl">
                                <use href="#icon-chart"/>
                            </svg>
                        </div>
                        <h4>Stock Analysis Dashboard</h4>
                        <p>Enter a ticker symbol above to get comprehensive stock analysis including:</p>
                        <ul class="feature-list">
                            <li><svg class="icon icon-sm icon-inline"><use href="#icon-trending-up"/></svg>Technical indicators and chart patterns</li>
                            <li><svg class="icon icon-sm icon-inline"><use href="#icon-dollar"/></svg>Fundamental analysis and financial metrics</li>
                            <li><svg class="icon icon-sm icon-inline"><use href="#icon-news"/></svg>News sentiment and social media analysis</li>
                            <li><svg class="icon icon-sm icon-inline"><use href="#icon-target"/></svg>Price targets and analyst recommendations</li>
                            <li><svg class="icon icon-sm icon-inline"><use href="#icon-zap"/></svg>Real-time market data and alerts</li>
                            <li><svg class="icon icon-sm icon-inline"><use href="#icon-pie-chart"/></svg>Comparative analysis with peers</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>
                    <svg class="icon icon-md icon-inline" style="stroke: var(--primary-blue-lighter);">
                        <use href="#icon-filter"/>
                    </svg>
                    Market Scanner
                </h3>
                <div class="scanner-controls">
                    <div class="scanner-filters">
                        <select id="sectorFilter" class="filter-select">
                            <option value="">All Sectors</option>
                            <option value="technology">Technology</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="finance">Finance</option>
                            <option value="energy">Energy</option>
                            <option value="consumer">Consumer</option>
                        </select>
                        <select id="marketCapFilter" class="filter-select">
                            <option value="">All Market Caps</option>
                            <option value="large">Large Cap (>$10B)</option>
                            <option value="mid">Mid Cap ($2B-$10B)</option>
                            <option value="small">Small Cap (<$2B)</option>
                        </select>
                        <button class="btn icon-button" onclick="scanMarket()">
                            <svg class="icon icon-sm">
                                <use href="#icon-filter"/>
                            </svg>
                            Scan Market
                        </button>
                    </div>
                    
                    <!-- Market Scanner History -->
                    <div class="ticker-memory-section" style="margin-top: 1rem;">
                        <label style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; display: block;">
                            <svg class="icon icon-sm icon-inline" style="stroke: var(--primary-blue-lighter);">
                                <use href="#icon-filter"/>
                            </svg>
                            Recent Market Scans:
                        </label>
                        <div class="ticker-memory-container" id="marketScanMemory">
                            <!-- Recent market scans will be populated here -->
                        </div>
                        <div class="memory-actions" style="margin-top: 0.5rem;">
                            <button class="btn btn-sm btn-secondary icon-button" onclick="clearMarketScanMemory()" title="Clear all saved market scans">
                                <svg class="icon icon-sm">
                                    <use href="#icon-x"/>
                                </svg>
                                Clear History
                            </button>
                        </div>
                    </div>
                </div>
                <div id="market-scanner-results">
                    <div class="placeholder-content">
                        <div class="placeholder-icon">ðŸ”</div>
                        <h4>Market Scanner</h4>
                        <p>Discover stocks based on your criteria:</p>
                        <ul class="feature-list">
                            <li>ðŸ“Š Filter by sector, market cap, and performance</li>
                            <li>ðŸŽ¯ Find stocks with specific technical patterns</li>
                            <li>ðŸ’° Identify undervalued or overvalued stocks</li>
                            <li>ðŸ“ˆ Track momentum and breakout candidates</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>
                    <svg class="icon icon-md icon-inline" style="stroke: var(--primary-blue);">
                        <use href="#icon-pie-chart"/>
                    </svg>
                    Portfolio Analysis
                </h3>
                <div id="portfolio-analysis">
                    <div class="placeholder-content">
                        <div class="placeholder-icon">ðŸ“Š</div>
                        <h4>Advanced Portfolio Analysis</h4>
                        <p>Deep dive into your portfolio performance:</p>
                        <ul class="feature-list">
                            <li>ðŸ“ˆ Performance attribution analysis</li>
                            <li>ðŸŽ¯ Sector and stock allocation optimization</li>
                            <li>ðŸ“Š Correlation analysis and diversification metrics</li>
                            <li>ðŸ’° Tax optimization and rebalancing suggestions</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div> <!-- End Stock Analysis Tab -->

        <!-- Social Media Tab -->
        <div id="social-tab" class="tab-content">
            <div class="card">
                <h3>
                    <svg class="icon icon-md icon-inline" style="stroke: var(--accent-emerald);">
                        <use href="#icon-social"/>
                    </svg>
                    Automated Social Media
                </h3>
                <div class="social-controls">
                    <div class="platform-selection">
                        <h4>Select Platforms</h4>
                        <div class="platform-checkboxes">
                            <label class="platform-option">
                                <input type="checkbox" id="twitterEnabled" checked>
                                <span class="platform-icon">ðŸ¦</span>
                                Twitter/X
                            </label>
                            <label class="platform-option">
                                <input type="checkbox" id="linkedinEnabled">
                                <span class="platform-icon">ðŸ’¼</span>
                                LinkedIn
                            </label>
                            <label class="platform-option">
                                <input type="checkbox" id="redditEnabled">
                                <span class="platform-icon">ðŸ¤–</span>
                                Reddit
                            </label>
                        </div>
                    </div>
                    <div class="content-settings">
                        <h4>Content Settings</h4>
                        <div class="setting-group">
                            <label for="postFrequency">Post Frequency:</label>
                            <select id="postFrequency" class="filter-select">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <label for="contentType">Content Type:</label>
                            <select id="contentType" class="filter-select">
                                <option value="portfolio">Portfolio Updates</option>
                                <option value="analysis">Market Analysis</option>
                                <option value="alerts">Price Alerts</option>
                                <option value="mixed">Mixed Content</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="social-actions">
                    <button class="btn icon-button" onclick="testSocialPost()">
                        <svg class="icon icon-sm">
                            <use href="#icon-zap"/>
                        </svg>
                        Test Post
                    </button>
                    <button class="btn icon-button" onclick="scheduleSocialPost()">
                        <svg class="icon icon-sm">
                            <use href="#icon-calendar"/>
                        </svg>
                        Schedule Post
                    </button>
                    <button class="btn icon-button" onclick="viewSocialHistory()">
                        <svg class="icon icon-sm">
                            <use href="#icon-activity"/>
                        </svg>
                        View History
                    </button>
                </div>
                <div id="social-results">
                    <div class="placeholder-content">
                        <div class="placeholder-icon">
                            <svg class="icon icon-2xl">
                                <use href="#icon-social"/>
                            </svg>
                        </div>
                        <h4>Social Media Automation</h4>
                        <p>Automate your social media presence with intelligent content:</p>
                        <ul class="feature-list">
                            <li><svg class="icon icon-sm icon-inline"><use href="#icon-pie-chart"/></svg>Auto-post portfolio performance updates</li>
                            <li><svg class="icon icon-sm icon-inline"><use href="#icon-trending-up"/></svg>Share market analysis and insights</li>
                            <li><svg class="icon icon-sm icon-inline"><use href="#icon-target"/></svg>Generate price alerts and notifications</li>
                            <li><svg class="icon icon-sm icon-inline"><use href="#icon-calendar"/></svg>Multi-platform posting and scheduling</li>
                            <li><svg class="icon icon-sm icon-inline"><use href="#icon-lightbulb"/></svg>AI-powered content generation</li>
                            <li><svg class="icon icon-sm icon-inline"><use href="#icon-activity"/></svg>Analytics and engagement tracking</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>
                    <svg class="icon icon-md icon-inline" style="stroke: var(--primary-blue-lighter);">
                        <use href="#icon-options"/>
                    </svg>
                    Content Templates
                </h3>
                <div class="template-controls">
                    <div class="template-categories">
                        <button class="template-category active" onclick="switchTemplateCategory('portfolio')">Portfolio</button>
                        <button class="template-category" onclick="switchTemplateCategory('analysis')">Analysis</button>
                        <button class="template-category" onclick="switchTemplateCategory('alerts')">Alerts</button>
                        <button class="template-category" onclick="switchTemplateCategory('custom')">Custom</button>
                    </div>
                </div>
                <div id="template-content">
                    <div class="placeholder-content">
                        <div class="placeholder-icon">ðŸ“</div>
                        <h4>Content Templates</h4>
                        <p>Pre-built templates for different types of posts:</p>
                        <ul class="feature-list">
                            <li>ðŸ“Š Portfolio performance summaries</li>
                            <li>ðŸ“ˆ Technical analysis insights</li>
                            <li>ðŸŽ¯ Trade alerts and notifications</li>
                            <li>ðŸ’¡ Market commentary and opinions</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>
                    <svg class="icon icon-md icon-inline" style="stroke: var(--accent-emerald);">
                        <use href="#icon-activity"/>
                    </svg>
                    Social Analytics
                </h3>
                <div id="social-analytics">
                    <div class="placeholder-content">
                        <div class="placeholder-icon">ðŸ“Š</div>
                        <h4>Social Media Analytics</h4>
                        <p>Track your social media performance:</p>
                        <ul class="feature-list">
                            <li>ðŸ“ˆ Engagement rates and reach metrics</li>
                            <li>ðŸŽ¯ Best performing content types</li>
                            <li>â° Optimal posting times</li>
                            <li>ðŸ‘¥ Audience growth and demographics</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div> <!-- End Social Media Tab -->

    </div> <!-- End Container -->

    <!-- Add Position Modal -->
    <div id="addPositionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddPositionModal()">&times;</span>
            <h3>Add New Position</h3>
            <form id="addPositionForm">
                <div class="form-group">
                    <label for="ticker">Ticker Symbol:</label>
                    <input type="text" id="ticker" name="ticker" required>
                </div>
                <div class="form-group">
                    <label for="position_type">Position Type:</label>
                    <select id="position_type" name="position_type" required>
                        <option value="stock">Stock</option>
                        <option value="call">Call Option</option>
                        <option value="put">Put Option</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quantity">Quantity:</label>
                    <input type="number" id="quantity" name="quantity" required>
                </div>
                <div class="form-group">
                    <label for="entry_price">Entry Price:</label>
                    <input type="number" id="entry_price" name="entry_price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="current_price">Current Price:</label>
                    <input type="number" id="current_price" name="current_price" step="0.01" required>
                </div>
                <div class="form-group" id="option_fields" style="display: none;">
                    <label for="strike_price">Strike Price:</label>
                    <input type="number" id="strike_price" name="strike_price" step="0.01">
                </div>
                <div class="form-group" id="expiration_fields" style="display: none;">
                    <label for="expiration_date">Expiration Date:</label>
                    <input type="date" id="expiration_date" name="expiration_date">
                </div>
                <button type="submit" class="btn">Add Position</button>
            </form>
        </div>
    </div>

    <!-- Score Breakdown Modal -->
    <div id="scoreBreakdownModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeScoreBreakdownModal()">&times;</span>
            <h3>
                <svg class="icon icon-md icon-inline" style="stroke: var(--primary-blue);">
                    <use href="#icon-pie-chart"/>
                </svg>
                Score Breakdown
            </h3>
            <div id="scoreBreakdownContent"></div>
        </div>
    </div>

    <!-- Trade Modal -->
    <div id="tradeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTradeModal()">&times;</span>
            <h3 id="tradeModalTitle">Execute Trade</h3>
            <form id="tradeForm">
                <div class="form-group">
                    <label for="trade_ticker">Ticker Symbol:</label>
                    <input type="text" id="trade_ticker" name="ticker" readonly>
                </div>
                <div class="form-group">
                    <label for="trade_type">Trade Type:</label>
                    <select id="trade_type" name="trade_type" readonly>
                        <option value="buy">Buy</option>
                        <option value="sell">Sell</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="trade_quantity">Quantity:</label>
                    <input type="number" id="trade_quantity" name="quantity" min="1" required>
                </div>
                <div class="form-group">
                    <label for="trade_price">Price per Share:</label>
                    <input type="number" id="trade_price" name="price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="trade_notes">Notes (optional):</label>
                    <textarea id="trade_notes" name="notes" rows="3" placeholder="Add any notes about this trade..."></textarea>
                </div>
                <div id="tradeSummary" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <h4>Trade Summary:</h4>
                    <p id="tradeSummaryText"></p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn" id="tradeSubmitBtn">Execute Trade</button>
                    <button type="button" class="btn" onclick="closeTradeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let portfolioData = null;
        let lastRefreshTime = null;



        let refreshInterval = null;

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸŒŸ DOM Content Loaded - Starting dashboard...');
            try {
                loadDashboard();
                
                // Initialize search memories
                migrateCSPTickerMemory(); // Convert old format to new individual ticker format
                updateCSPTickerMemory();
                updateStockSearchMemory();
                updateMarketScanMemory();
                
                // Restore previously active tab after browser refresh (F5)
                restoreActiveTab();
                
                // Initialize ticker memory display
                updateCSPTickerMemoryDisplay();
                
            } catch (error) {
                console.error('âŒ Critical error in loadDashboard:', error);
                document.getElementById('loadingContainer').style.display = 'none';
                alert('Error loading dashboard. Check console for details.');
            }
            
            // Set up auto-refresh every 5 minutes
            refreshInterval = setInterval(refreshDashboard, 5 * 60 * 1000);
            
            // Show/hide option fields based on position type
            document.getElementById('position_type').addEventListener('change', function() {
                const optionFields = document.getElementById('option_fields');
                const expirationFields = document.getElementById('expiration_fields');
                if (this.value === 'call' || this.value === 'put') {
                    optionFields.style.display = 'block';
                    expirationFields.style.display = 'block';
                } else {
                    optionFields.style.display = 'none';
                    expirationFields.style.display = 'none';
                }
            });

            // Load risk data when risk tab is first accessed
            document.getElementById('tab-risk').addEventListener('click', function() {
                if (document.getElementById('risk-overview').innerHTML.includes('Loading')) {
                    loadRiskData();
                    updateRiskCharts();
                }
            });
        });

        async function refreshDashboard() {
            const refreshButton = document.querySelector('.refresh-button');
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            // Remember current active tab before refresh
            const activeTab = document.querySelector('.tab-content.active');
            const currentTabId = activeTab ? activeTab.id.replace('-tab', '') : 'overview';
            
            // Show loading state
            refreshButton.innerHTML = '<div class="loading-spinner"></div>';
            statusIndicator.className = 'status-indicator status-offline';
            statusText.textContent = 'Refreshing...';
            
            try {
                // Force full refresh (not fast mode) when manually refreshing
                await loadDashboard(false);
                lastRefreshTime = new Date();
                statusIndicator.className = 'status-indicator status-online';
                statusText.textContent = 'Online';
                showSuccess('Dashboard refreshed successfully!');
                
                // Restore the tab that was active before refresh
                if (currentTabId !== 'overview') {
                    setTimeout(() => {
                        switchTab(currentTabId);
                    }, 100); // Small delay to ensure data is loaded
                }
            } catch (error) {
                console.error('Error refreshing dashboard:', error);
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Offline';
                showError('Failed to refresh dashboard');
            } finally {
                refreshButton.innerHTML = 'ðŸ”„';
            }
        }

        // Loading progress tracking
        let loadingProgress = 0;
        let loadingSteps = [
            { id: 'db', text: 'Connecting to database...', progress: 10 },
            { id: 'positions', text: 'Loading portfolio positions...', progress: 30 },
            { id: 'basic', text: 'Calculating basic metrics...', progress: 50 },
            { id: 'prices', text: 'Updating real-time prices...', progress: 70 },
            { id: 'risk', text: 'Calculating risk metrics...', progress: 85 },
            { id: 'analysis', text: 'Generating portfolio analysis...', progress: 100 }
        ];
        
        function updateProgress(stepId, status = 'active') {
            const step = loadingSteps.find(s => s.id === stepId);
            if (!step) return;
            
            // Update progress bar
            loadingProgress = Math.max(loadingProgress, step.progress);
            document.getElementById('progressFill').style.width = loadingProgress + '%';
            document.getElementById('progressText').textContent = step.text;
            
            // Update loading item
            const item = document.getElementById(`loadingItem${stepId}`);
            if (item) {
                item.className = `loading-item ${status}`;
                const icon = item.querySelector('.loading-icon');
                if (status === 'active') {
                    icon.textContent = 'â³';
                } else if (status === 'completed') {
                    icon.textContent = 'âœ…';
                } else if (status === 'error') {
                    icon.textContent = 'âŒ';
                }
            }
        }
        
        function addLoadingItem(stepId, text) {
            const details = document.getElementById('loadingDetails');
            const item = document.createElement('div');
            item.className = 'loading-item';
            item.id = `loadingItem${stepId}`;
            item.innerHTML = `
                <span class="loading-icon">â³</span>
                <span class="loading-text">${text}</span>
            `;
            details.appendChild(item);
        }
        
        async function loadDashboard(useFastMode = true) {
            try {
                console.log('ðŸš€ Starting dashboard load...');
                
                // Initialize loading UI
                loadingProgress = 0;
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('loadingDetails').innerHTML = '';
                
                // Add all loading steps
                loadingSteps.forEach(step => {
                    addLoadingItem(step.id, step.text);
                });
                
                // Step 1: Database connection (fastest)
                updateProgress('db', 'active');
                console.log('âœ… Step 1: Simulating DB connection...');
                await new Promise(resolve => setTimeout(resolve, 100)); // Simulate DB connection
                updateProgress('db', 'completed');
                console.log('âœ… Step 1 complete');
                
                // Step 2: Load positions (fast, shows data immediately)
                updateProgress('positions', 'active');
                console.log('ðŸ“Š Step 2: Loading positions...');
                await loadPositions();
                console.log('âœ… Step 2 complete');
                updateProgress('positions', 'completed');
                
                // Step 3: Basic metrics (fast, uses position data)
                updateProgress('basic', 'active');
                console.log('ðŸ“Š Step 3: Loading basic metrics...');
                await loadBasicMetrics();
                console.log('âœ… Step 3 complete');
                updateProgress('basic', 'completed');
                
                // Hide loading screen as soon as basic data is loaded
                console.log('ðŸŽ‰ Hiding loading screen...');
                setTimeout(() => {
                    document.getElementById('loadingContainer').style.display = 'none';
                    console.log('âœ… Loading screen hidden');
                }, 500);
                
                // Step 4: Real-time prices (can be slow, but runs in background)
                updateProgress('prices', 'active');
                loadRealTimePrices().then(() => {
updateProgress('prices', 'completed');
                }).catch(error => {
                    console.error('Error loading real-time prices:', error);
                    updateProgress('prices', 'error');
                });
                
                // Step 5: Risk metrics (slowest, but runs in background)
                updateProgress('risk', 'active');
                loadRiskMetrics().then(() => {
                    updateProgress('risk', 'completed');
                }).catch(error => {
                    console.error('Error loading risk metrics:', error);
                    updateProgress('risk', 'error');
                });
                
                // Step 6: Portfolio analysis (comprehensive, runs in background)
                updateProgress('analysis', 'active');
                loadPortfolioAnalysis().then(() => {
                    updateProgress('analysis', 'completed');
                }).catch(error => {
                    console.error('Error loading portfolio analysis:', error);
                    updateProgress('analysis', 'error');
                });
                
            } catch (error) {
                console.error('âŒ ERROR loading dashboard:', error);
                console.error('Error details:', error.message, error.stack);
                
                // Hide loading screen on error
                document.getElementById('loadingContainer').style.display = 'none';
                
                // Show error message
                document.getElementById('portfolio-summary').innerHTML = 
                    '<div class="error" style="padding: 2rem; text-align: center;">' +
                    '<h3>Failed to load dashboard</h3>' +
                    '<p>Error: ' + error.message + '</p>' +
                    '<p>Check the browser console (F12) for details</p>' +
                    '</div>';
            }
        }
        
        async function loadBasicMetrics() {
            // Calculate basic metrics from position data
            if (allPositions.length === 0) return;
            
            const totalValue = allPositions.reduce((sum, pos) => sum + (pos.quantity * pos.current_price), 0);
            const stocks = allPositions.filter(pos => pos.position_type === 'stock');
            const options = allPositions.filter(pos => pos.position_type === 'call' || pos.position_type === 'put');
            
            // Update portfolio summary immediately
            const summaryHtml = `
                <div class="portfolio-main-metrics">
                    <div class="main-metric">
                        <div class="main-value">$${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="main-label">Total Portfolio</div>
                    </div>
                    <div class="main-metric">
                        <div class="main-value">${allPositions.length.toLocaleString()}</div>
                        <div class="main-label">Total Positions</div>
                    </div>
                    <div class="main-metric">
                        <div class="main-value">${stocks.length.toLocaleString()}</div>
                        <div class="main-label">Stocks</div>
                    </div>
                    <div class="main-metric">
                        <div class="main-value">${options.length.toLocaleString()}</div>
                        <div class="main-label">Options</div>
                    </div>
                </div>
            `;
            
            document.getElementById('portfolio-summary').innerHTML = summaryHtml;
        }
        
        async function loadRealTimePrices() {
            // This would update prices in the background
            // For now, just simulate the delay
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        async function loadRiskMetrics() {
            // Load risk metrics in the background
            try {
                const response = await axios.get('/api/portfolio/risk-metrics?fast_mode=true');
                // Risk metrics are already displayed in their respective sections
            } catch (error) {
                console.error('Error loading risk metrics:', error);
            }
        }
        
        async function loadPortfolioAnalysis() {
            // Load comprehensive analysis in the background
            try {
                await Promise.all([
                    loadStockMetrics(),
                    loadOptionsMetrics(),
                    loadConcentrationAnalysis()
                ]);
            } catch (error) {
                console.error('Error loading portfolio analysis:', error);
            }
        }

        async function loadPortfolioSummary(useFastMode = true) {
            try {
                // Use fast mode on initial load for better performance
                const url = useFastMode ? '/api/portfolio/risk-metrics?fast_mode=true' : '/api/portfolio/risk-metrics';
                const response = await axios.get(url);
                const data = response.data;
                
                if (data.message) {
                    document.getElementById('portfolio-summary').innerHTML = 
                        '<div class="summary-item"><div class="summary-value">0</div><div class="summary-label">No positions</div></div>';
                    return;
                }

                // Use only portfolio value (investments) to match Merrill platform
                const totalValue = data.portfolio_value;
                const summaryHtml = `
                    <div class="portfolio-main-metrics">
                        <div class="main-metric">
                            <div class="main-value">$${(totalValue / 1000).toFixed(0)}k</div>
                            <div class="main-label">Total Portfolio</div>
                        </div>
                        <div class="main-metric">
                            <div class="main-value">$${(data.total_pnl / 1000).toFixed(0)}k</div>
                            <div class="main-label">P&L</div>
                        </div>
                        <div class="main-metric">
                            <div class="main-value">${data.total_pnl_pct.toFixed(1)}%</div>
                            <div class="main-label">Return</div>
                        </div>
                    </div>
                    <div class="portfolio-details">
                        <div class="detail-row">
                            <span class="detail-label">Stocks:</span>
                            <span class="detail-value">${data.stocks.count}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Options:</span>
                            <span class="detail-value">${data.options.count}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Total Positions:</span>
                            <span class="detail-value">${data.position_count}</span>
                        </div>
                        <div class="detail-row csp-cash-row">
                            <span class="detail-label">CSP Cash Required:</span>
                            <span class="detail-value">$${(data.csp_required_cash / 1000).toFixed(0)}k</span>
                        </div>
                    </div>
                `;
                
                document.getElementById('portfolio-summary').innerHTML = summaryHtml;
            } catch (error) {
                console.error('Error loading portfolio summary:', error);
            }
        }

        async function loadStockMetrics() {
            try {
                const response = await axios.get('/api/portfolio/risk-metrics-fast');
                const data = response.data;
                
                console.log('Stock metrics data:', data);
                
                if (data.message) {
                    document.getElementById('stock-metrics').innerHTML = 
                        '<div class="metric"><div class="metric-value">0</div><div class="metric-label">No data</div></div>';
                    return;
                }

                const stocks = data.stocks || {};
                const metricsHtml = `
                    <div class="metric">
                        <div class="metric-value">${(stocks.count || 0).toLocaleString()}</div>
                        <div class="metric-label">Stock Positions</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">$${(stocks.total_value || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="metric-label">Stock Value</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${(stocks.avg_pnl_pct || 0).toFixed(2)}%</div>
                        <div class="metric-label">Avg P&L %</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${(stocks.unique_tickers || 0).toLocaleString()}</div>
                        <div class="metric-label">Unique Tickers</div>
                    </div>
                `;
                
                document.getElementById('stock-metrics').innerHTML = metricsHtml;
            } catch (error) {
                console.error('Error loading stock metrics:', error);
            }
        }

        async function loadOptionsMetrics() {
            try {
                const response = await axios.get('/api/portfolio/risk-metrics-fast');
                const data = response.data;
                
                console.log('Options metrics data:', data);
                
                if (data.message) {
                    document.getElementById('options-metrics').innerHTML = 
                        '<div class="metric"><div class="metric-value">0</div><div class="metric-label">No data</div></div>';
                    return;
                }

                const options = data.options || {};
                const metricsHtml = `
                    <div class="metric">
                        <div class="metric-value">${(options.count || 0).toLocaleString()}</div>
                        <div class="metric-label">Option Positions</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">$${(options.total_value || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="metric-label">Options Value</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value ${(options.avg_delta || 0) >= 0 ? 'positive' : 'negative'}">${(options.avg_delta || 0).toFixed(2)}</div>
                        <div class="metric-label">Avg Delta</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value neutral">${(options.avg_theta || 0).toFixed(2)}</div>
                        <div class="metric-label">Avg Theta</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${(options.calls || 0).toLocaleString()}</div>
                        <div class="metric-label">Calls</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${(options.puts || 0).toLocaleString()}</div>
                        <div class="metric-label">Puts</div>
                    </div>
                `;
                
                document.getElementById('options-metrics').innerHTML = metricsHtml;
                
                // Update Greeks display - pass the full data object, not just options
                console.log('Updating Greeks display with data:', data);
                console.log('Options object:', options);
                console.log('Greeks object:', data.greeks);
                updateGreeksDisplay(options, data.greeks);
            } catch (error) {
                console.error('Error loading options metrics:', error);
                document.getElementById('greeks-display').innerHTML = '<div class="error">Failed to load Greeks data</div>';
            }
        }

        function updateGreeksDisplay(options, greeks) {
            try {
                console.log('updateGreeksDisplay called with options:', options, 'greeks:', greeks);
                
                // Use the options object for average Greeks (per position)
                const avgDelta = options.avg_delta || 0;
                const avgGamma = options.avg_gamma || 0;
                const avgTheta = options.avg_theta || 0;
                const avgVega = options.avg_vega || 0;
                
                // Use total Greeks for portfolio exposure
                const totalDelta = greeks.total_delta || 0;
                const totalGamma = greeks.total_gamma || 0;
                const totalTheta = greeks.total_theta || 0;
                const totalVega = greeks.total_vega || 0;
            
            // Helper function to format values with appropriate precision
            function formatGreek(value, decimals) {
                const absValue = Math.abs(value);
                const formatted = absValue.toFixed(decimals);
                return value >= 0 ? formatted : `-${formatted}`;
            }
            
            // Helper function to get color class based on value
            function getColorClass(value) {
                if (value === 0) return '';
                return value >= 0 ? 'positive' : 'negative';
            }
            
            const greeksHtml = `
                <div class="metric-card">
                    <div class="metric-label">Delta</div>
                    <div class="metric-value ${getColorClass(totalDelta)}">${formatGreek(totalDelta, 2)}</div>
                    <div class="metric-description">Total: ${formatGreek(totalDelta, 2)} | Avg: ${formatGreek(avgDelta, 3)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Gamma</div>
                    <div class="metric-value ${getColorClass(totalGamma)}">${formatGreek(totalGamma, 2)}</div>
                    <div class="metric-description">Total: ${formatGreek(totalGamma, 2)} | Avg: ${formatGreek(avgGamma, 4)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Theta</div>
                    <div class="metric-value ${getColorClass(totalTheta)}">${formatGreek(totalTheta, 2)}</div>
                    <div class="metric-description">Total: ${formatGreek(totalTheta, 2)}/day | Avg: ${formatGreek(avgTheta, 3)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Vega</div>
                    <div class="metric-value ${getColorClass(totalVega)}">${formatGreek(totalVega, 2)}</div>
                    <div class="metric-description">Total: ${formatGreek(totalVega, 2)} | Avg: ${formatGreek(avgVega, 4)}</div>
                </div>
            `;
            
                document.getElementById('greeks-display').innerHTML = greeksHtml;
            } catch (error) {
                console.error('Error in updateGreeksDisplay:', error);
                document.getElementById('greeks-display').innerHTML = '<div class="error">Error displaying Greeks</div>';
            }
        }

        async function loadConcentrationAnalysis() {
            try {
                const response = await axios.get('/api/portfolio/risk-metrics-fast');
                const data = response.data;
                
                console.log('Concentration analysis data:', data);
                
                if (data.message) {
                    document.getElementById('concentration-analysis').innerHTML = 
                        '<p>No positions to analyze</p>';
                    return;
                }

                const concentration = data.concentration;
                console.log('Concentration object:', concentration);
                
                // Build top 10 positions table
                let top10Html = '';
                if (concentration.top_10_positions && concentration.top_10_positions.length > 0) {
                    top10Html = `
                        <div style="margin-top: 1.5rem;">
                            <h4 style="color: #333; margin-bottom: 1rem; font-size: 1rem;">Top 10 Positions</h4>
                            <table style="width: 100%; font-size: 0.9rem;">
                                <thead>
                                    <tr>
                                        <th style="text-align: left; padding: 0.5rem;">Rank</th>
                                        <th style="text-align: left; padding: 0.5rem;">Ticker</th>
                                        <th style="text-align: right; padding: 0.5rem;">Value</th>
                                        <th style="text-align: right; padding: 0.5rem;">Weight</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${concentration.top_10_positions.map((pos, idx) => `
                                        <tr style="border-bottom: 1px solid #eee;">
                                            <td style="padding: 0.5rem;">${idx + 1}</td>
                                            <td style="padding: 0.5rem; font-weight: 600;">${pos.ticker}</td>
                                            <td style="text-align: right; padding: 0.5rem;">$${pos.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                            <td style="text-align: right; padding: 0.5rem;">
                                                <span style="color: ${pos.weight > 10 ? '#dc2626' : pos.weight > 5 ? '#f59e0b' : '#10b981'};">
                                                    ${pos.weight.toFixed(2)}%
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                const analysisHtml = `
                    <div class="risk-metrics">
                        <div class="metric">
                            <div class="metric-value">${concentration.top_5_concentration.toFixed(1)}%</div>
                            <div class="metric-label">Top 5 Concentration</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${concentration.hhi.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div class="metric-label">HHI Index</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${concentration.max_position_weight.toFixed(1)}%</div>
                            <div class="metric-label">Max Position</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${concentration.position_count.toLocaleString()}</div>
                            <div class="metric-label">All Positions</div>
                        </div>
                    </div>
                    ${top10Html}
                `;
                
                document.getElementById('concentration-analysis').innerHTML = analysisHtml;
            } catch (error) {
                console.error('Error loading concentration analysis:', error);
                document.getElementById('concentration-analysis').innerHTML = '<div class="error">Failed to load concentration data</div>';
            }
        }

        let allPositions = [];
        let filteredPositions = [];

        function showLoadingProgress(title, message, details = '') {
            const progressContainer = document.getElementById('loadingContainer');
            if (progressContainer) {
                progressContainer.innerHTML = `
                    <div class="loading-header">
                        <div class="spinner"></div>
                        <h3>${title}</h3>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%; animation: pulse 1.5s ease-in-out infinite;"></div>
                        </div>
                        <div class="progress-text">${message}</div>
                        ${details ? `<div class="progress-details" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">${details}</div>` : ''}
                    </div>
                `;
                progressContainer.style.display = 'block';
            }
        }

        function hideLoadingProgress() {
            const progressContainer = document.getElementById('loadingContainer');
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
        }

        async function loadPositions() {
            try {
                const startTime = Date.now();
                
                // First, try to get basic positions quickly
                const response = await axios.get('/api/portfolio/positions');
                allPositions = response.data;
                filteredPositions = [...allPositions];
                
                const loadTime = Date.now() - startTime;
                
                if (allPositions.length === 0) {
                    document.getElementById('positions-table').innerHTML = 
                        '<p>No positions in portfolio. Add some positions to get started!</p>';
                    return;
                }

                // Count positions by type and sort by ticker
                const stocks = allPositions.filter(pos => pos.position_type === 'stock');
                const options = allPositions.filter(pos => pos.position_type === 'call' || pos.position_type === 'put');
                const calls = options.filter(pos => pos.position_type === 'call');
                const puts = options.filter(pos => pos.position_type === 'put');
                
                // Calculate portfolio value
                const totalValue = allPositions.reduce((sum, pos) => sum + (pos.quantity * pos.current_price), 0);
                
                console.log(`ðŸ“Š Loaded ${allPositions.length} positions: ${stocks.length} stocks, ${options.length} options (${calls.length} calls, ${puts.length} puts) in ${(loadTime/1000).toFixed(1)}s`);
                console.log(`ðŸ’° Portfolio value: $${totalValue.toLocaleString()}`);

                // Sort by ticker by default
                filteredStocks = stocks.sort((a, b) => a.ticker.localeCompare(b.ticker));
                filteredOptions = options.sort((a, b) => a.ticker.localeCompare(b.ticker));
                
                // Render immediately with basic data
                renderPositionsTable();
                
                // Update stock and options metrics immediately with basic data
                updateStockMetrics();
                updateOptionsMetrics();
                
            } catch (error) {
                console.error('Error loading positions:', error);
                document.getElementById('positions-table').innerHTML = 
                    '<p class="error">Failed to load positions. Please try again.</p>';
            }
        }
        
        function updateStockMetrics() {
            const stocks = allPositions.filter(pos => pos.position_type === 'stock');
            const stockCount = stocks.length;
            const stockValue = stocks.reduce((sum, pos) => sum + (pos.quantity * pos.current_price), 0);
            const avgPnL = stocks.length > 0 ? stocks.reduce((sum, pos) => {
                const pnl = ((pos.current_price - pos.entry_price) / pos.entry_price) * 100;
                return sum + pnl;
            }, 0) / stocks.length : 0;
            const uniqueTickers = new Set(stocks.map(pos => pos.ticker)).size;
            
            // Update stock metrics display
            const stockMetrics = document.getElementById('stock-metrics');
            if (stockMetrics) {
                stockMetrics.innerHTML = `
                    <div class="metric">
                        <div class="metric-value">${stockCount}</div>
                        <div class="metric-label">STOCK POSITIONS</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">$${stockValue.toLocaleString()}</div>
                        <div class="metric-label">STOCK VALUE</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value ${avgPnL >= 0 ? 'positive' : 'negative'}">${avgPnL.toFixed(2)}%</div>
                        <div class="metric-label">AVG P&L %</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${uniqueTickers}</div>
                        <div class="metric-label">UNIQUE TICKERS</div>
                    </div>
                `;
            }
        }
        
        function updateOptionsMetrics() {
            const options = allPositions.filter(pos => pos.position_type === 'call' || pos.position_type === 'put');
            const calls = options.filter(pos => pos.position_type === 'call');
            const puts = options.filter(pos => pos.position_type === 'put');
            
            const optionCount = options.length;
            const optionValue = options.reduce((sum, pos) => sum + (pos.quantity * pos.current_price), 0);
            const avgDelta = options.length > 0 ? options.reduce((sum, pos) => sum + (pos.delta || 0), 0) / options.length : 0;
            const avgTheta = options.length > 0 ? options.reduce((sum, pos) => sum + (pos.theta || 0), 0) / options.length : 0;
            
            // Update options metrics display
            const optionsMetrics = document.getElementById('options-metrics');
            if (optionsMetrics) {
                optionsMetrics.innerHTML = `
                    <div class="metric">
                        <div class="metric-value">${optionCount}</div>
                        <div class="metric-label">OPTION POSITIONS</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">$${optionValue.toLocaleString()}</div>
                        <div class="metric-label">OPTIONS VALUE</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${avgDelta.toFixed(2)}</div>
                        <div class="metric-label">AVG DELTA</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${avgTheta.toFixed(2)}</div>
                        <div class="metric-label">AVG THETA</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${calls.length}</div>
                        <div class="metric-label">CALLS</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${puts.length}</div>
                        <div class="metric-label">PUTS</div>
                    </div>
                `;
            }
        }

        function renderPositionsTable() {
            // Use the independent filtered arrays
            const stocks = filteredStocks.length > 0 ? filteredStocks : allPositions.filter(pos => pos.position_type === 'stock');
            const options = filteredOptions.length > 0 ? filteredOptions : allPositions.filter(pos => pos.position_type === 'call' || pos.position_type === 'put');
            
            if (stocks.length === 0 && options.length === 0) {
                document.getElementById('positions-table').innerHTML = 
                    '<p>No positions match the current filters.</p>';
                return;
            }

            let tablesHtml = '';

            // Stocks table
            if (stocks.length > 0) {
                tablesHtml += `
                    <h4 style="margin-top: 2rem; margin-bottom: 1rem; color: #1e3a8a; font-weight: 600;">ðŸ“ˆ Stock Positions</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Quantity</th>
                                <th>Entry Price</th>
                                <th>Current Price</th>
                                <th>Value</th>
                                <th>P&L</th>
                                <th>P&L %</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stocks.map((pos, index) => {
                                const pnl = pos.quantity * (pos.current_price - pos.entry_price);
                                const pnlPct = ((pos.current_price - pos.entry_price) / pos.entry_price) * 100;
                                const value = pos.quantity * pos.current_price;
                                return `
                                    <tr>
                                        <td>${pos.ticker}</td>
                                        <td>${pos.quantity}</td>
                                        <td>$${pos.entry_price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td>$${pos.current_price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td>$${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td class="${pnl >= 0 ? 'positive' : 'negative'}">$${pnl.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td class="${pnlPct >= 0 ? 'positive' : 'negative'}">${pnlPct.toFixed(2)}%</td>
                                        <td>
                                            <div style="display: flex; gap: 0.15rem; flex-wrap: nowrap; align-items: center; justify-content: center;">
                                                <button class="btn btn-success compact-btn" onclick="openTradeModal('${pos.ticker}', 'buy', ${pos.current_price})" title="Buy ${pos.ticker}">ðŸ“ˆ</button>
                                                <button class="btn btn-danger compact-btn" onclick="openTradeModal('${pos.ticker}', 'sell', ${pos.current_price})" title="Sell ${pos.ticker}">ðŸ“‰</button>
                                                <button class="btn btn-danger compact-btn" onclick="deletePosition(${allPositions.indexOf(pos)})" title="Delete Position">ðŸ—‘ï¸</button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }

            // Options table
            if (options.length > 0) {
                // Sort options: Calls first, then Puts, then by ticker alphabetically
                options.sort((a, b) => {
                    // First sort by option type (call before put)
                    if (a.position_type !== b.position_type) {
                        return a.position_type === 'call' ? -1 : 1;
                    }
                    // Then sort by ticker
                    return a.ticker.localeCompare(b.ticker);
                });
                
                tablesHtml += `
                    <h4 style="margin-top: 2rem; margin-bottom: 1rem; color: #1e3a8a; font-weight: 600;">ðŸ“Š Options Positions (Calls First)</h4>
                    <!-- Options Table Filters -->
                    <div class="options-table-filters" style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <h5 style="color: #1e3a8a; margin-bottom: 1rem; font-size: 0.9rem; font-weight: 600;">Options Table Filters</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div class="form-group">
                                <label for="options-table-ticker-filter">Ticker:</label>
                                <input type="text" id="options-table-ticker-filter" placeholder="Filter options by ticker..." onkeyup="filterOptionsTable()">
                            </div>
                            <div class="form-group">
                                <label for="options-table-type-filter">Option Type:</label>
                                <select id="options-table-type-filter" onchange="filterOptionsTable()">
                                    <option value="">All Options</option>
                                    <option value="call">Calls Only</option>
                                    <option value="put">Puts Only</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="options-table-sort-by">Sort by:</label>
                                <select id="options-table-sort-by" onchange="sortOptionsTable()">
                                    <option value="ticker">Ticker</option>
                                    <option value="strike">Strike Price</option>
                                    <option value="expiry">Expiry Date</option>
                                    <option value="delta">Delta</option>
                                    <option value="theta">Theta</option>
                                    <option value="pnl">P&L</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="options-table-sort-order">Sort Order:</label>
                                <select id="options-table-sort-order" onchange="sortOptionsTable()">
                                    <option value="asc">Ascending</option>
                                    <option value="desc">Descending</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Type</th>
                                <th>Strike</th>
                                <th>Expiry</th>
                                <th>Quantity</th>
                                <th>Entry Price</th>
                                <th>Current Price</th>
                                <th>Value</th>
                                <th>P&L</th>
                                <th>P&L %</th>
                                <th>Delta</th>
                                <th>Gamma</th>
                                <th>Theta</th>
                                <th>Vega</th>
                                <th>IV</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${options.map((pos, index) => {
                                const pnl = pos.quantity * (pos.current_price - pos.entry_price);
                                const pnlPct = ((pos.current_price - pos.entry_price) / pos.entry_price) * 100;
                                const value = pos.quantity * pos.current_price;
                                return `
                                    <tr>
                                        <td>${pos.ticker}</td>
                                        <td><span class="position-type ${pos.position_type}">${pos.position_type.toUpperCase()}</span></td>
                                        <td>$${pos.strike_price ? pos.strike_price.toFixed(2) : 'N/A'}</td>
                                        <td>${pos.expiration_date ? formatDate(pos.expiration_date) : 'N/A'}</td>
                                        <td>${pos.quantity}</td>
                                        <td>$${pos.entry_price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td>$${pos.current_price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td>$${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td class="${pnl >= 0 ? 'positive' : 'negative'}">$${pnl.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td class="${pnlPct >= 0 ? 'positive' : 'negative'}">${pnlPct.toFixed(2)}%</td>
                                        <td>${pos.delta ? pos.delta.toFixed(3) : 'N/A'}</td>
                                        <td>${pos.gamma ? pos.gamma.toFixed(4) : 'N/A'}</td>
                                        <td>${pos.theta ? pos.theta.toFixed(3) : 'N/A'}</td>
                                        <td>${pos.vega ? pos.vega.toFixed(5) : 'N/A'}</td>
                                        <td>${pos.implied_volatility ? (pos.implied_volatility * 100).toFixed(1) + '%' : 'N/A'}</td>
                                        <td>
                                            <div style="display: flex; gap: 0.15rem; flex-wrap: nowrap; align-items: center; justify-content: center;">
                                                <button class="btn btn-success compact-btn" onclick="openTradeModal('${pos.ticker}', 'buy', ${pos.current_price})" title="Buy ${pos.ticker}">ðŸ“ˆ</button>
                                                <button class="btn btn-danger compact-btn" onclick="openTradeModal('${pos.ticker}', 'sell', ${pos.current_price})" title="Sell ${pos.ticker}">ðŸ“‰</button>
                                                <button class="btn btn-danger compact-btn" onclick="deletePosition(${allPositions.indexOf(pos)})" title="Delete Position">ðŸ—‘ï¸</button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }

            if (stocks.length === 0 && options.length === 0) {
                tablesHtml = '<p>No positions match the current filters.</p>';
            }
            
            document.getElementById('positions-table').innerHTML = tablesHtml;
        }

        function filterPositions() {
            const stockTickerFilter = document.getElementById('stock-ticker-filter').value.toLowerCase();
            
            // Filter stocks independently
            const allStocks = allPositions.filter(pos => pos.position_type === 'stock');
            filteredStocks = allStocks.filter(pos => {
                return !stockTickerFilter || pos.ticker.toLowerCase().includes(stockTickerFilter);
            });
            
            // Initialize options if not already filtered
            if (filteredOptions.length === 0) {
                const allOptions = allPositions.filter(pos => pos.position_type === 'call' || pos.position_type === 'put');
                filteredOptions = allOptions;
            }
            
            renderPositionsTable();
        }

        function sortPositions() {
            // Sort stocks independently
            if (filteredStocks.length > 0) {
                const stockSortBy = document.getElementById('stock-sort-by').value;
                const stockSortOrder = document.getElementById('stock-sort-order').value;
                filteredStocks.sort((a, b) => sortComparator(a, b, stockSortBy, stockSortOrder));
            }
            
            renderPositionsTable();
        }
        
        function sortComparator(a, b, sortBy, sortOrder) {
            let aValue, bValue;
            
            switch (sortBy) {
                case 'ticker':
                    aValue = a.ticker;
                    bValue = b.ticker;
                    break;
                case 'quantity':
                    aValue = a.quantity;
                    bValue = b.quantity;
                    break;
                case 'pnl':
                    aValue = a.quantity * (a.current_price - a.entry_price);
                    bValue = b.quantity * (b.current_price - b.entry_price);
                    break;
                case 'pnl_pct':
                    aValue = ((a.current_price - a.entry_price) / a.entry_price) * 100;
                    bValue = ((b.current_price - b.entry_price) / b.entry_price) * 100;
                    break;
                case 'value':
                    aValue = a.quantity * a.current_price;
                    bValue = b.quantity * b.current_price;
                    break;
                case 'strike':
                    aValue = a.strike_price || 0;
                    bValue = b.strike_price || 0;
                    break;
                case 'expiry':
                    aValue = a.expiration_date ? new Date(a.expiration_date) : new Date('2099-12-31');
                    bValue = b.expiration_date ? new Date(b.expiration_date) : new Date('2099-12-31');
                    break;
                case 'delta':
                    aValue = a.delta || 0;
                    bValue = b.delta || 0;
                    break;
                case 'theta':
                    aValue = a.theta || 0;
                    bValue = b.theta || 0;
                    break;
                default:
                    return 0;
            }
            
            if (typeof aValue === 'string') {
                return sortOrder === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
            } else {
                return sortOrder === 'asc' ? aValue - bValue : bValue - aValue;
            }
        }

        function clearFilters() {
            // Clear stock filters
            document.getElementById('stock-ticker-filter').value = '';
            document.getElementById('stock-sort-by').value = 'ticker';
            document.getElementById('stock-sort-order').value = 'asc';
            
            // Clear options table filters (if they exist)
            const optionsTickerFilter = document.getElementById('options-table-ticker-filter');
            const optionsTypeFilter = document.getElementById('options-table-type-filter');
            const optionsSortBy = document.getElementById('options-table-sort-by');
            const optionsSortOrder = document.getElementById('options-table-sort-order');
            
            if (optionsTickerFilter) optionsTickerFilter.value = '';
            if (optionsTypeFilter) optionsTypeFilter.value = '';
            if (optionsSortBy) optionsSortBy.value = 'ticker';
            if (optionsSortOrder) optionsSortOrder.value = 'asc';
            
            // Reset filtered arrays
            filteredStocks = [];
            filteredOptions = [];
            
            renderPositionsTable();
        }

        function showAllPositions() {
            clearFilters();
        }

        function showOnlyStocks() {
            // Clear all filters first
            clearFilters();
            // Show only stocks
            filteredStocks = allPositions.filter(pos => pos.position_type === 'stock');
            filteredOptions = [];
            renderPositionsTable();
        }

        function showOnlyOptions() {
            // Clear all filters first
            clearFilters();
            // Show only options
            filteredStocks = [];
            filteredOptions = allPositions.filter(pos => pos.position_type === 'call' || pos.position_type === 'put');
            renderPositionsTable();
        }

        // Global variables to track filtered positions
        let filteredStocks = [];
        let filteredOptions = [];

        // Helper function to format dates correctly (avoid timezone issues)
        function formatDate(dateString) {
            try {
                // Handle different date formats
                let date;
                if (dateString.includes('T')) {
                    // ISO format with time
                    date = new Date(dateString);
                } else {
                    // Date-only format - parse manually to avoid timezone issues
                    const parts = dateString.split('-');
                    if (parts.length === 3) {
                        // Create date in local timezone
                        date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                    } else {
                        date = new Date(dateString);
                    }
                }
                
                // Format as MM/DD/YYYY
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (error) {
                console.error('Error formatting date:', dateString, error);
                return dateString; // Return original string if formatting fails
            }
        }

        function filterOptionsTable() {
            // Filter options independently
            const optionsTickerFilter = document.getElementById('options-table-ticker-filter').value.toLowerCase();
            const optionsTypeFilter = document.getElementById('options-table-type-filter').value;
            
            const allOptions = allPositions.filter(pos => pos.position_type === 'call' || pos.position_type === 'put');
            filteredOptions = allOptions.filter(pos => {
                const matchesTicker = !optionsTickerFilter || pos.ticker.toLowerCase().includes(optionsTickerFilter);
                const matchesType = !optionsTypeFilter || pos.position_type === optionsTypeFilter;
                return matchesTicker && matchesType;
            });
            
            renderPositionsTable();
        }

        function sortOptionsTable() {
            // Sort options independently
            const optionsSortBy = document.getElementById('options-table-sort-by').value;
            const optionsSortOrder = document.getElementById('options-table-sort-order').value;
            
            filteredOptions.sort((a, b) => sortComparator(a, b, optionsSortBy, optionsSortOrder));
            renderPositionsTable();
        }

        function openAddPositionModal() {
            document.getElementById('addPositionModal').style.display = 'block';
        }

        function closeAddPositionModal() {
            document.getElementById('addPositionModal').style.display = 'none';
            document.getElementById('addPositionForm').reset();
        }

        function openTradeModal(ticker, tradeType, currentPrice) {
            const modal = document.getElementById('tradeModal');
            const title = document.getElementById('tradeModalTitle');
            const submitBtn = document.getElementById('tradeSubmitBtn');
            
            // Set form values
            document.getElementById('trade_ticker').value = ticker;
            document.getElementById('trade_type').value = tradeType;
            document.getElementById('trade_price').value = currentPrice.toFixed(2);
            document.getElementById('trade_quantity').value = '';
            document.getElementById('trade_notes').value = '';
            
            // Update title and button
            title.textContent = `${tradeType.toUpperCase()} ${ticker}`;
            submitBtn.textContent = `Execute ${tradeType.toUpperCase()}`;
            submitBtn.className = tradeType === 'buy' ? 'btn btn-success' : 'btn btn-danger';
            
            // Show modal
            modal.style.display = 'block';
            
            // Update trade summary
            updateTradeSummary();
        }

        function closeTradeModal() {
            document.getElementById('tradeModal').style.display = 'none';
            document.getElementById('tradeForm').reset();
        }

        function updateTradeSummary() {
            const quantity = parseInt(document.getElementById('trade_quantity').value) || 0;
            const price = parseFloat(document.getElementById('trade_price').value) || 0;
            const tradeType = document.getElementById('trade_type').value;
            const ticker = document.getElementById('trade_ticker').value;
            
            if (quantity > 0 && price > 0) {
                const totalCost = quantity * price;
                const summaryText = document.getElementById('tradeSummaryText');
                summaryText.innerHTML = `
                    <strong>${tradeType.toUpperCase()} ${quantity} shares of ${ticker}</strong><br>
                    Price: $${price.toFixed(2)} per share<br>
                    Total Cost: $${totalCost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                `;
            } else {
                document.getElementById('tradeSummaryText').textContent = 'Enter quantity and price to see trade summary';
            }
        }

        document.getElementById('addPositionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const positionData = Object.fromEntries(formData.entries());
            
            try {
                await axios.post('/api/portfolio/positions', positionData);
                closeAddPositionModal();
                showSuccess('Position added successfully!');
                loadDashboard();
            } catch (error) {
                console.error('Error adding position:', error);
                showError('Failed to add position');
            }
        });

        document.getElementById('tradeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const tradeData = Object.fromEntries(formData.entries());
            
            try {
                const response = await axios.post('/api/portfolio/trade', tradeData);
                closeTradeModal();
                showSuccess(response.data.message);
                loadDashboard(); // Refresh the dashboard to show updated positions
            } catch (error) {
                console.error('Error executing trade:', error);
                showError(error.response?.data?.detail || 'Failed to execute trade');
            }
        });

        // Add event listeners for trade form fields
        document.getElementById('trade_quantity').addEventListener('input', updateTradeSummary);
        document.getElementById('trade_price').addEventListener('input', updateTradeSummary);

        async function deletePosition(index) {
            if (confirm('Are you sure you want to delete this position?')) {
                try {
                    await axios.delete(`/api/portfolio/positions/${index}`);
                    showSuccess('Position deleted successfully!');
                    loadDashboard();
                } catch (error) {
                    console.error('Error deleting position:', error);
                    showError('Failed to delete position');
                }
            }
        }

        async function exportPortfolio() {
            try {
                const response = await axios.get('/api/portfolio/export');
                const csv = response.data.csv;
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `portfolio_export_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showSuccess('Portfolio exported successfully!');
            } catch (error) {
                console.error('Error exporting portfolio:', error);
                showError('Failed to export portfolio');
            }
        }

        function importPortfolio() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            axios.post('/api/portfolio/import', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            })
            .then(response => {
                showSuccess('Portfolio imported successfully!');
                loadDashboard();
            })
            .catch(error => {
                console.error('Error importing portfolio:', error);
                showError('Failed to import portfolio');
            });
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.container').firstChild);
            setTimeout(() => successDiv.remove(), 3000);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.container').firstChild);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showInfo(message) {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'info';
            infoDiv.textContent = message;
            document.querySelector('.container').insertBefore(infoDiv, document.querySelector('.container').firstChild);
            setTimeout(() => infoDiv.remove(), 4000);
        }


        // Tab switching functions
        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to selected tab button
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Save current tab to localStorage for browser refresh persistence
            localStorage.setItem('activeTab', tabName);
            
            // Start auto-refresh if switching to risk tab
            if (tabName === 'risk') {
                loadRiskData();
                startRiskAutoRefresh();
            } else {
                stopRiskAutoRefresh();
            }
        }
        
        // Restore tab from localStorage on page load
        function restoreActiveTab() {
            const savedTab = localStorage.getItem('activeTab');
            if (savedTab && savedTab !== 'overview') {
                // Wait for dashboard to load, then restore tab
                setTimeout(() => {
                    switchTab(savedTab);
                }, 500); // Wait for initial data load
            }
        }
        
        // Auto-refresh risk data every 60 seconds when on risk tab
        let riskRefreshInterval = null;
        
        function startRiskAutoRefresh() {
            // Clear any existing interval
            if (riskRefreshInterval) {
                clearInterval(riskRefreshInterval);
            }
            
            // Refresh every 60 seconds
            riskRefreshInterval = setInterval(() => {
                // Only refresh if we're on the risk tab
                const riskTab = document.getElementById('risk-tab');
                if (riskTab && riskTab.classList.contains('active')) {
                    console.log('Auto-refreshing risk data...');
                    loadRiskData();
                }
            }, 60000); // 60 seconds
        }
        
        function stopRiskAutoRefresh() {
            if (riskRefreshInterval) {
                clearInterval(riskRefreshInterval);
                riskRefreshInterval = null;
            }
        }
        
        async function refreshRiskData() {
            // Reload risk data and stay on risk tab
            console.log('Refreshing risk data...');
            await loadRiskData();
            
            // Ensure we stay on risk tab after refresh
            setTimeout(() => {
                const riskTab = document.getElementById('risk-tab');
                if (riskTab && !riskTab.classList.contains('active')) {
                    console.log('Restoring risk tab...');
                    switchTab('risk');
                }
            }, 100);
            
            console.log('Risk data refreshed!');
        }
        
        // Tooltip data for risk metrics
        const riskTooltips = {
            overall_risk_score: {
                title: "Overall Risk Score",
                description: "A composite score (0-100) measuring your portfolio's overall risk level. Considers concentration, volatility, and liquidity risks combined.",
                interpretation: "0-25: Low Risk | 25-50: Medium Risk | 50-75: High Risk | 75-100: Critical Risk",
                example: "A score of 65 means your portfolio has high risk, likely due to concentration in few positions or high volatility."
            },
            concentration_risk: {
                title: "Concentration Risk",
                description: "Measures how much of your portfolio is concentrated in a few positions. Uses the Herfindahl-Hirschman Index (HHI).",
                interpretation: "Higher scores indicate more concentration risk. Above 50 suggests too much exposure to single positions.",
                example: "If 40% of your portfolio is in one stock, concentration risk will be high (60+), suggesting you should diversify."
            },
            volatility_risk: {
                title: "Volatility Risk Score",
                description: "Measures potential price fluctuation in your portfolio based on position types and diversity.",
                interpretation: "0-25: Stable | 25-50: Moderate swings | 50-75: High volatility | 75-100: Extreme fluctuations",
                example: "A portfolio with many short-dated options will have higher volatility risk than one with only blue-chip stocks."
            },
            liquidity_risk: {
                title: "Liquidity Risk Score",
                description: "Measures how easily you can exit positions without significantly affecting prices. Based on trading volume.",
                interpretation: "0-25: Highly liquid | 25-50: Adequate | 50-75: Concerning | 75-100: Poor liquidity",
                example: "Large positions in low-volume stocks increases liquidity risk - you can't sell quickly without moving prices."
            },
            stock_count: {
                title: "Stock Position Count",
                description: "Number of individual stock positions in your portfolio.",
                interpretation: "More positions generally means better diversification, but requires more management.",
                example: "10 stock positions is a common sweet spot for retail investors - enough diversification without overwhelming complexity."
            },
            stock_value: {
                title: "Total Stock Value",
                description: "Combined market value of all stock positions in your portfolio.",
                interpretation: "Shows how much capital is allocated to stocks vs options or other assets.",
                example: "$50,000 in stocks out of $75,000 total portfolio means 67% stock allocation."
            },
            stock_pnl: {
                title: "Stock P&L Percentage",
                description: "Average profit/loss percentage across all stock positions since purchase.",
                interpretation: "Positive is good! Shows overall stock performance. Compare to market benchmarks like S&P 500.",
                example: "+15% stock P&L means your stocks have gained 15% on average since purchase."
            },
            unique_tickers: {
                title: "Unique Stock Tickers",
                description: "Number of different companies you own stock in.",
                interpretation: "5-10: Focused | 10-20: Diversified | 20-30: Well diversified | 30+: May be over-diversified",
                example: "15 unique tickers provides good diversification while remaining manageable."
            },
            max_position_pct: {
                title: "Maximum Position Percentage",
                description: "Percentage of your stock portfolio in your single largest stock holding.",
                interpretation: "<10%: Well balanced | 10-20%: Acceptable | 20-30%: High concentration | 30%+: Risky",
                example: "If 25% of stocks are in AAPL, that single stock drop will significantly impact your portfolio."
            },
            options_count: {
                title: "Options Position Count",
                description: "Number of options contracts (calls and puts) in your portfolio.",
                interpretation: "More options = more complexity and risk. Typical retail: 5-20 positions.",
                example: "15 option positions requires active management, especially as expiration approaches."
            },
            options_value: {
                title: "Total Options Value",
                description: "Combined market value of all options positions (premium Ã— quantity Ã— 100).",
                interpretation: "Options typically represent leverage. $10k in options can control $100k+ in underlying stock.",
                example: "$15,000 in options with $50,000 in stocks means 23% options allocation (moderate leverage)."
            },
            total_delta: {
                title: "Total Portfolio Delta",
                description: "Net directional exposure of all options. Positive = bullish, negative = bearish. Measures market direction risk.",
                interpretation: "+50: Like owning 50 shares | -30: Like shorting 30 shares | 0: Market neutral",
                example: "Delta of +100 means your options behave like 100 shares of stock. A 1% market move affects you like 100 shares."
            },
            total_gamma: {
                title: "Total Portfolio Gamma",
                description: "Rate of change of delta. High gamma means delta changes quickly as price moves.",
                interpretation: "Low (<5): Stable delta | Medium (5-15): Moderate changes | High (15+): Delta changes rapidly",
                example: "Gamma of 10 means if stock moves $1, your delta changes by 10. Short-dated options have higher gamma."
            },
            portfolio_beta: {
                title: "Portfolio Beta",
                description: "Measures your portfolio's sensitivity to overall market movements. Beta of 1.0 means you move with the market.",
                interpretation: "Beta < 1: Less volatile than market | Beta = 1: Moves with market | Beta > 1: More volatile than market",
                example: "Beta of 1.5 means if the market goes up 10%, your portfolio likely goes up 15%. Same for downside."
            },
            portfolio_volatility: {
                title: "Portfolio Volatility",
                description: "Annual volatility (standard deviation) of portfolio returns. Indicates how much returns vary from average.",
                interpretation: "10-15%: Low | 15-25%: Moderate | 25-40%: High | 40%+: Very High",
                example: "30% volatility means ~68% of the time, your annual return will be within Â±30% of your average return."
            },
            sharpe_ratio: {
                title: "Sharpe Ratio",
                description: "Risk-adjusted return measure. Shows how much extra return you get per unit of risk taken.",
                interpretation: "< 0: Poor | 0-1: Subpar | 1-2: Good | 2-3: Very Good | 3+: Excellent",
                example: "Sharpe of 1.5 means you earn 1.5% return for every 1% of risk. Higher is better."
            },
            max_drawdown: {
                title: "Maximum Drawdown",
                description: "The largest peak-to-trough decline in portfolio value. Shows worst historical loss from a high point.",
                interpretation: "10%: Low | 10-20%: Moderate | 20-30%: High | 30%+: Very High",
                example: "15% max drawdown means your portfolio fell 15% from its peak at worst. You need 17.6% gain to recover."
            },
            var_95: {
                title: "Value at Risk (95%)",
                description: "Maximum expected loss over 1 day with 95% confidence. In other words, 95% of days, losses won't exceed this.",
                interpretation: "Shows your 'bad day' loss threshold. Only 5% of days should see losses exceeding this amount.",
                example: "VaR 95% of $5,000 means on 95% of days, you won't lose more than $5,000."
            },
            var_99: {
                title: "Value at Risk (99%)",
                description: "Maximum expected loss over 1 day with 99% confidence. Your 'very bad day' loss threshold.",
                interpretation: "More extreme than VaR 95%. Only 1% of days (about 2-3 trading days/year) should exceed this loss.",
                example: "VaR 99% of $8,000 means only 2-3 days per year should you expect losses over $8,000."
            },
            total_delta: {
                title: "Total Portfolio Delta",
                description: "Net directional exposure of all options. Positive = bullish, negative = bearish. Measures market direction risk.",
                interpretation: "+50: Equivalent to 50 shares long | -30: Equivalent to 30 shares short | 0: Market neutral",
                example: "Delta of +100 means your options behave like 100 shares of stock. A 1% market move affects you like 100 shares."
            },
            total_theta: {
                title: "Total Portfolio Theta",
                description: "Daily time decay of your options portfolio. Measures how much value changes each day due to time passing.",
                interpretation: "Positive theta (GREEN) = You're an option SELLER - earning premium daily ðŸ’° | Negative theta (RED) = You're an option BUYER - losing to time decay",
                example: "Theta of +$790/day means you EARN $790 daily as options decay. Over 30 days = $23,700 profit from time alone!"
            },
            total_gamma: {
                title: "Total Portfolio Gamma",
                description: "Rate of change of your portfolio's delta. High gamma means your delta changes rapidly with price movements.",
                interpretation: "Low (<5): Very stable delta | Medium (5-15): Moderate delta changes | High (15+): Rapid delta changes",
                example: "Gamma of 10 means if underlying moves $1, your total delta changes by 10. Short-dated ATM options have highest gamma."
            },
            total_vega: {
                title: "Total Portfolio Vega",
                description: "Sensitivity to implied volatility changes. Shows dollar P&L impact if IV changes by 1 percentage point.",
                interpretation: "Positive vega: Profit from IV increase | Negative vega: Profit from IV decrease | Higher = more IV risk",
                example: "Vega of +500 means if IV increases from 30% to 31% (+1%), you gain $500. During earnings, IV can swing 10-20%."
            },
            theta_30d: {
                title: "30-Day Theta Collection",
                description: "Total projected time decay over the next 30 days for your options positions.",
                interpretation: "Positive (GREEN) = You COLLECT this premium as a seller ðŸ’° | Negative (RED) = You LOSE this to time decay as a buyer",
                example: "$23.7k in 30-day theta means you'll COLLECT $23,700 in premium over the next month as options decay (assuming price/IV unchanged)!"
            },
            expiring_7d_value: {
                title: "Expiring in 7 Days",
                description: "Total notional value of options expiring within 7 days. Requires immediate attention.",
                interpretation: "High values indicate urgent action needed - must close, roll, or let expire.",
                example: "$15k expiring in 7 days means you have $15k of options that need decisions very soon."
            },
            expiring_30d_value: {
                title: "Expiring in 30 Days",
                description: "Total notional value of options expiring within 30 days. Should start planning actions soon.",
                interpretation: "< $10k: Manageable | $10-30k: Moderate workload | $30k+: High management burden ahead",
                example: "$40k expiring in 30 days means significant positions will need rolling or closing decisions soon."
            },
            liquidity_score: {
                title: "Portfolio Liquidity Score",
                description: "Composite score (0-100%) measuring how easily you can exit all positions without significantly impacting prices.",
                interpretation: "80-100%: Highly liquid | 50-80%: Adequate liquidity | 30-50%: Some concerns | <30%: Poor liquidity",
                example: "65% means you can exit most positions quickly, but some larger holdings may take time or move the market."
            },
            expected_shortfall: {
                title: "Expected Shortfall (CVaR)",
                description: "Average loss on days when VaR threshold is exceeded. Measures tail risk - how bad things get when they go really bad.",
                interpretation: "Shows average loss beyond VaR. Compare to VaR 95%: if CVaR is 50% higher, you have significant tail risk.",
                example: "VaR 95% = $5k, CVaR = $7k means when you have bad days (>$5k loss), they average $7k (40% worse than threshold)."
            },
            top_5_concentration: {
                title: "Top 5 Concentration",
                description: "Percentage of portfolio in your 5 largest positions. Measures concentration risk.",
                interpretation: "< 50%: Well diversified | 50-70%: Moderate concentration | 70%+: High concentration risk",
                example: "75% in top 5 means if those 5 positions perform poorly, your entire portfolio suffers significantly."
            },
            expiring_7d: {
                title: "Options Expiring in 7 Days",
                description: "Number of option contracts expiring within the next week. Requires immediate attention!",
                interpretation: "0-2: Manageable | 3-5: Busy week ahead | 6+: Very high management workload",
                example: "5 options expiring in 3 days means you need decisions NOW: close, roll, or let expire on each position."
            },
            expiring_30d: {
                title: "Options Expiring in 30 Days",
                description: "Number of option contracts expiring within the next month. Plan your actions soon.",
                interpretation: "Shows positions entering high time-decay zone. Start planning to roll or close.",
                example: "10 options expiring in 30 days means you should start evaluating which to roll vs close."
            },
            time_decay_risk: {
                title: "Time Decay Risk Score",
                description: "Composite score (0-100) measuring theta decay risk based on days to expiry and theta values.",
                interpretation: "0-25: Low decay | 25-50: Moderate | 50-75: High decay | 75-100: Critical decay",
                example: "Score of 70 means you have significant daily losses from time decay - consider rolling positions."
            },
            avg_days_to_expiry: {
                title: "Average Days to Expiration",
                description: "Average number of days until your options expire, weighted by position value.",
                interpretation: "7-14: Very short-term | 14-45: Short-term | 45-90: Medium-term | 90+: Long-term",
                example: "20 days average means most positions are short-term and will experience rapid theta decay."
            },
            positions_at_risk: {
                title: "Positions at Risk",
                description: "Number of positions exceeding risk thresholds (concentration >15%, expiring soon, high volatility).",
                interpretation: "0: All healthy | 1-3: Monitor closely | 4-6: Concerning | 7+: Take action",
                example: "3 at risk might be: 1 concentrated position (25% of portfolio), 2 expiring in 3 days."
            },
            expiring_soon: {
                title: "Expiring Soon Count",
                description: "Number of option positions expiring within 7 days. These require immediate attention.",
                interpretation: "0-2: Manageable | 3-5: Busy week | 6-10: Very busy | 10+: Overwhelming",
                example: "5 options expiring this week means you need to decide: close, roll, or let expire on each one."
            },
            expected_shortfall: {
                title: "Expected Shortfall (CVaR)",
                description: "Average loss on days when VaR threshold is exceeded. Shows tail risk severity.",
                interpretation: "Shows how bad things get when they go really bad. Higher = more extreme losses.",
                example: "If VaR is $5k and CVaR is $7k, when losses exceed $5k, they average $7k (40% worse)."
            }
        };
        
        function createTooltip(key, currentValue = null) {
            const tooltip = riskTooltips[key];
            if (!tooltip) return '';
            
            // Add current value to interpretation if provided
            let interpretationText = tooltip.interpretation;
            if (currentValue !== null) {
                interpretationText = `<strong>Your Value: ${currentValue}</strong><br><br>${tooltip.interpretation}`;
            }
            
            return `
                <span class="tooltip-container">
                    <span class="tooltip-icon">?</span>
                    <div class="tooltip-content">
                        <div class="tooltip-title">${tooltip.title}</div>
                        <div class="tooltip-description">${tooltip.description}</div>
                        <div class="tooltip-example">
                            <div class="tooltip-example-title">Interpretation:</div>
                            ${interpretationText}
                        </div>
                        <div class="tooltip-example">
                            <div class="tooltip-example-title">Example:</div>
                            ${tooltip.example}
                        </div>
                    </div>
                </span>
            `;
        }

        // Risk monitoring functions with progressive loading
        async function loadRiskData() {
            try {
                // Load fast metrics first (with alerts)
                const fastResponse = await axios.get('/api/portfolio/risk-monitor/fast');
                displayFastRiskOverview(fastResponse.data);
                displayRiskAlerts(fastResponse.data.alerts);
                
                // Then load detailed metrics in background
                const detailedResponse = await axios.get('/api/portfolio/risk-monitor/detailed');
                displayDetailedRiskMetrics(detailedResponse.data);
            } catch (error) {
                console.error('Error loading risk data:', error);
                document.getElementById('risk-overview').innerHTML = '<p class="error">Failed to load risk data</p>';
            }
        }
        
        function displayFastRiskOverview(data) {
            const riskOverview = document.getElementById('risk-overview');
            
            // Get risk level and color
            const getRiskLevel = (score) => {
                if (score >= 75) return { level: 'Critical', color: '#dc2626', bg: '#fee2e2' };
                if (score >= 50) return { level: 'High', color: '#ea580c', bg: '#ffedd5' };
                if (score >= 25) return { level: 'Medium', color: '#f59e0b', bg: '#fef3c7' };
                return { level: 'Low', color: '#059669', bg: '#d1fae5' };
            };
            
            const overallRisk = getRiskLevel(data.risk_scores.overall);
            
            const html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <!-- Overall Risk Score -->
                    <div style="background: ${overallRisk.bg}; border-left: 4px solid ${overallRisk.color}; padding: 1.5rem; border-radius: 8px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                            Overall Risk Level ${createTooltip('overall_risk_score')}
                        </div>
                        <div style="font-size: 2rem; font-weight: bold; color: ${overallRisk.color}; margin-bottom: 0.25rem;">
                            ${data.risk_scores.overall}/100
                        </div>
                        <div style="font-size: 1rem; font-weight: 600; color: ${overallRisk.color};">
                            ${overallRisk.level} Risk
                        </div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
                            Calculated in ${data.calculation_time_ms.toFixed(0)}ms
                        </div>
                    </div>
                    
                    <!-- Portfolio Overview -->
                    <div style="background: white; border-left: 4px solid #3b82f6; padding: 1.5rem; border-radius: 8px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Portfolio Value</div>
                        <div style="font-size: 1.8rem; font-weight: bold; color: #1e3a8a;">
                            $${(data.portfolio_value / 1000).toFixed(1)}k
                        </div>
                        <div style="font-size: 1rem; color: ${data.total_pnl >= 0 ? '#059669' : '#dc2626'}; font-weight: 600; margin-top: 0.5rem;">
                            ${data.total_pnl >= 0 ? '+' : ''}$${(data.total_pnl / 1000).toFixed(1)}k (${data.total_pnl_pct.toFixed(2)}%)
                        </div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
                            ${data.counts.total_positions} total positions
                        </div>
                    </div>
                    
                    <!-- Risk Metrics -->
                    <div style="background: white; border-left: 4px solid #d4af37; padding: 1.5rem; border-radius: 8px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
                            Risk Breakdown ${createTooltip('concentration_risk')}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.85rem; color: #666;">
                                    Concentration ${createTooltip('concentration_risk')}
                                </span>
                                <span style="font-weight: 600; color: ${data.risk_scores.concentration > 50 ? '#dc2626' : '#059669'};">
                                    ${data.risk_scores.concentration}/100
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.85rem; color: #666;">
                                    Volatility ${createTooltip('volatility_risk')}
                                </span>
                                <span style="font-weight: 600; color: ${data.risk_scores.volatility > 50 ? '#dc2626' : '#059669'};">
                                    ${data.risk_scores.volatility}/100
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.85rem; color: #666;">
                                    Liquidity ${createTooltip('liquidity_risk')}
                                </span>
                                <span style="font-weight: 600; color: ${data.risk_scores.liquidity > 50 ? '#dc2626' : '#059669'};">
                                    ${data.risk_scores.liquidity}/100
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Position Risk -->
                    <div style="background: white; border-left: 4px solid ${data.counts.positions_at_risk > 0 ? '#ea580c' : '#059669'}; padding: 1.5rem; border-radius: 8px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                            Positions at Risk ${createTooltip('positions_at_risk')}
                        </div>
                        <div style="font-size: 2rem; font-weight: bold; color: ${data.counts.positions_at_risk > 0 ? '#ea580c' : '#059669'};">
                            ${data.counts.positions_at_risk}
                        </div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
                            ${data.counts.expiring_soon} expiring soon (7d) ${createTooltip('expiring_soon')}
                        </div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                            Max position: ${data.max_position_risk.toFixed(1)}%
                        </div>
                    </div>
                </div>
            `;
            
            riskOverview.innerHTML = html;
        }
        
        function displayRiskAlerts(alerts) {
            const alertsContainer = document.getElementById('risk-alerts');
            if (!alertsContainer) return;
            
            if (!alerts || alerts.length === 0) {
                alertsContainer.innerHTML = `
                    <div style="background: #d1fae5; border-left: 4px solid #059669; padding: 1rem; border-radius: 8px;">
                        <strong style="color: #059669;">âœ“ No active risk alerts</strong>
                        <p style="color: #666; margin-top: 0.5rem; font-size: 0.9rem;">Your portfolio is within acceptable risk parameters</p>
                    </div>
                `;
                return;
            }
            
            const getAlertColor = (level) => {
                if (level === 'critical') return { color: '#dc2626', bg: '#fee2e2', icon: 'ðŸš¨' };
                if (level === 'warning') return { color: '#f59e0b', bg: '#fef3c7', icon: 'âš ï¸' };
                return { color: '#3b82f6', bg: '#dbeafe', icon: 'â„¹ï¸' };
            };
            
            const alertsHtml = alerts.map(alert => {
                const style = getAlertColor(alert.level);
                return `
                    <div style="background: ${style.bg}; border-left: 4px solid ${style.color}; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <strong style="color: ${style.color}; font-size: 1rem;">
                                ${style.icon} ${alert.message}
                            </strong>
                            <span style="background: ${style.color}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                                ${alert.level}
                            </span>
                        </div>
                        <p style="color: #666; font-size: 0.9rem; margin: 0.5rem 0;">
                            <strong>Category:</strong> ${alert.category.charAt(0).toUpperCase() + alert.category.slice(1)}
                        </p>
                        <p style="color: #666; font-size: 0.9rem; margin: 0.5rem 0;">
                            <strong>Affected:</strong> ${alert.affected_positions.join(', ')}
                        </p>
                        <p style="background: white; padding: 0.75rem; border-radius: 6px; color: #444; font-size: 0.9rem; margin-top: 0.75rem;">
                            <strong>ðŸ“‹ Recommendation:</strong> ${alert.recommendation}
                        </p>
                    </div>
                `;
            }).join('');
            
            alertsContainer.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <h4 style="color: #1e3a8a; margin-bottom: 1rem;">
                        ðŸ”” Active Risk Alerts (${alerts.length})
                    </h4>
                    ${alertsHtml}
                </div>
            `;
        }
        
        function displayDetailedRiskMetrics(data) {
            const riskMetrics = document.getElementById('risk-metrics');
            
            const html = `
                <h4 style="color: #1e3a8a; margin-bottom: 1rem; margin-top: 0;">ðŸ“Š Options Risk Metrics</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <!-- Options Greeks -->
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Total Delta ${createTooltip('total_delta', data.greeks.total_delta.toFixed(2))}</div>
                        <div class="risk-metric-value ${Math.abs(data.greeks.total_delta) > 100 ? 'warning' : 'positive'}">
                            ${data.greeks.total_delta.toFixed(2)}
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Total Gamma ${createTooltip('total_gamma', data.greeks.total_gamma.toFixed(2))}</div>
                        <div class="risk-metric-value ${Math.abs(data.greeks.total_gamma) > 10 ? 'warning' : 'positive'}">
                            ${data.greeks.total_gamma.toFixed(2)}
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Total Theta ($/day) ${createTooltip('total_theta', '$' + data.greeks.total_theta.toFixed(0))}</div>
                        <div class="risk-metric-value ${data.greeks.total_theta > 0 ? 'positive' : 'negative'}">
                            $${data.greeks.total_theta.toFixed(0)}
                            ${data.greeks.total_theta > 0 ? ' ðŸ’°' : ''}
                        </div>
                        ${data.greeks.total_theta > 0 ? '<div style="font-size: 0.75rem; color: #10b981; margin-top: 0.25rem;">Option Seller</div>' : '<div style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem;">Option Buyer</div>'}
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Total Vega ${createTooltip('total_vega', data.greeks.total_vega.toFixed(2))}</div>
                        <div class="risk-metric-value">
                            ${data.greeks.total_vega.toFixed(2)}
                        </div>
                    </div>
                    
                    <!-- Time Decay for Options -->
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">30-Day Theta ${createTooltip('theta_30d', '$' + (data.time_decay.theta_30d / 1000).toFixed(1) + 'k')}</div>
                        <div class="risk-metric-value ${data.time_decay.theta_30d > 0 ? 'positive' : 'negative'}">
                            $${(data.time_decay.theta_30d / 1000).toFixed(1)}k
                            ${data.time_decay.theta_30d > 0 ? ' ðŸ’°' : ''}
                        </div>
                        ${data.time_decay.theta_30d > 0 ? '<div style="font-size: 0.75rem; color: #10b981; margin-top: 0.25rem;">Seller Profit</div>' : ''}
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Expiring 7d Value ${createTooltip('expiring_7d_value', '$' + (data.time_decay.expiring_7d_value / 1000).toFixed(1) + 'k')}</div>
                        <div class="risk-metric-value warning">
                            $${(data.time_decay.expiring_7d_value / 1000).toFixed(1)}k
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Expiring 30d Value ${createTooltip('expiring_30d_value', '$' + (data.time_decay.expiring_30d_value / 1000).toFixed(1) + 'k')}</div>
                        <div class="risk-metric-value warning">
                            $${(data.time_decay.expiring_30d_value / 1000).toFixed(1)}k
                        </div>
                    </div>
                </div>
                
                <h4 style="color: #1e3a8a; margin-bottom: 1rem; margin-top: 1.5rem;">ðŸ“ˆ Stock Risk Metrics</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <!-- Stock Metrics -->
                    <!-- Stock Concentration -->
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Top 5 Concentration ${createTooltip('top_5_concentration')}</div>
                        <div class="risk-metric-value ${data.concentration.top_5 > 75 ? 'warning' : 'positive'}">
                            ${data.concentration.top_5.toFixed(1)}%
                        </div>
                    </div>
                    
                    <!-- Stock Portfolio Metrics -->
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Portfolio Beta ${createTooltip('portfolio_beta', data.portfolio_metrics.beta.toFixed(2))}</div>
                        <div class="risk-metric-value ${data.portfolio_metrics.beta < 0.8 ? 'positive' : data.portfolio_metrics.beta < 1.2 ? 'info' : data.portfolio_metrics.beta < 1.5 ? 'warning' : 'negative'}">
                            ${data.portfolio_metrics.beta.toFixed(2)}
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Volatility ${createTooltip('portfolio_volatility', (data.portfolio_metrics.volatility * 100).toFixed(1) + '%')}</div>
                        <div class="risk-metric-value ${data.portfolio_metrics.volatility < 0.2 ? 'positive' : data.portfolio_metrics.volatility < 0.4 ? 'info' : data.portfolio_metrics.volatility < 0.6 ? 'warning' : 'negative'}">
                            ${(data.portfolio_metrics.volatility * 100).toFixed(1)}%
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Liquidity Score ${createTooltip('liquidity_score', (data.liquidity.avg_score * 100).toFixed(0))}</div>
                        <div class="risk-metric-value ${data.liquidity.avg_score >= 0.8 ? 'positive' : data.liquidity.avg_score >= 0.5 ? 'warning' : 'negative'}">
                            ${(data.liquidity.avg_score * 100).toFixed(0)}
                        </div>
                    </div>
                </div>
                
                <h4 style="color: #1e3a8a; margin-bottom: 1rem; margin-top: 1.5rem;">ðŸ“‰ Portfolio Risk Measurements</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <!-- Risk Measurements -->
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">VaR 95% ${createTooltip('var_95', '$' + (data.risk_measurements.var_95 / 1000).toFixed(1) + 'k')}</div>
                        <div class="risk-metric-value negative">
                            $${(data.risk_measurements.var_95 / 1000).toFixed(1)}k
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">VaR 99% ${createTooltip('var_99', '$' + (data.risk_measurements.var_99 / 1000).toFixed(1) + 'k')}</div>
                        <div class="risk-metric-value negative">
                            $${(data.risk_measurements.var_99 / 1000).toFixed(1)}k
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Expected Shortfall ${createTooltip('expected_shortfall', '$' + (data.risk_measurements.expected_shortfall / 1000).toFixed(1) + 'k')}</div>
                        <div class="risk-metric-value negative">
                            $${(data.risk_measurements.expected_shortfall / 1000).toFixed(1)}k
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Sharpe Ratio ${createTooltip('sharpe_ratio', data.portfolio_metrics.sharpe_ratio.toFixed(2))}</div>
                        <div class="risk-metric-value ${data.portfolio_metrics.sharpe_ratio > 1 ? 'positive' : 'warning'}">
                            ${data.portfolio_metrics.sharpe_ratio.toFixed(2)}
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Max Drawdown ${createTooltip('max_drawdown', (data.portfolio_metrics.max_drawdown * 100).toFixed(1) + '%')}</div>
                        <div class="risk-metric-value ${data.portfolio_metrics.max_drawdown > 0.2 ? 'negative' : 'warning'}">
                            ${(data.portfolio_metrics.max_drawdown * 100).toFixed(1)}%
                        </div>
                    </div>
                </div>
                
                ${Object.keys(data.concentration.by_sector).length > 0 ? `
                    <div style="margin-top: 2rem;">
                        <h4 style="color: #1e3a8a; margin-bottom: 1rem;">Sector Concentration</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem;">
                            ${Object.entries(data.concentration.by_sector).map(([sector, pct]) => `
                                <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #3b82f6;">
                                    <div style="font-size: 0.8rem; color: #666;">${sector}</div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: #1e3a8a;">${pct.toFixed(1)}%</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
            
            riskMetrics.innerHTML = html;
        }

        function displayRiskOverview(data) {
            const riskOverview = document.getElementById('risk-overview');
            
            const html = `
                <div class="risk-metric-grid">
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Portfolio Value</div>
                        <div class="risk-metric-value">$${data.portfolio_value?.toLocaleString() || '0'}</div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Total P&L</div>
                        <div class="risk-metric-value ${data.total_pnl >= 0 ? 'positive' : 'negative'}">
                            $${data.total_pnl?.toLocaleString() || '0'} (${data.total_pnl_pct?.toFixed(2) || '0'}%)
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">CSP Required Cash</div>
                        <div class="risk-metric-value warning">$${data.csp_required_cash?.toLocaleString() || '0'}</div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Cash Balance</div>
                        <div class="risk-metric-value">$${data.cash_balance?.toLocaleString() || '0'}</div>
                    </div>
                </div>
            `;
            
            riskOverview.innerHTML = html;
        }

        function displayRiskMetrics(data) {
            const riskMetrics = document.getElementById('risk-metrics');
            
            // Check if we have real market data
            const isRealData = data.data_source === 'real_market_data';
            const dataSource = isRealData ? 'Real Market Data' : 'Fallback Data';
            
            const html = `
                <div style="margin-bottom: 1rem; padding: 0.5rem; background: ${isRealData ? '#d1fae5' : '#fef3c7'}; border-radius: 6px; border-left: 4px solid ${isRealData ? '#059669' : '#d97706'};">
                    <strong>Data Source:</strong> ${dataSource}
                </div>
                
                <div class="risk-metric-grid">
                    <!-- Portfolio Risk Metrics -->
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Portfolio Volatility</div>
                        <div class="risk-metric-value ${data.portfolio_volatility > 0.3 ? 'warning' : 'positive'}">
                            ${(data.portfolio_volatility * 100)?.toFixed(1) || '0'}%
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Portfolio Beta</div>
                        <div class="risk-metric-value ${data.portfolio_beta > 1.5 ? 'warning' : 'positive'}">
                            ${data.portfolio_beta?.toFixed(2) || '0'}
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Sharpe Ratio</div>
                        <div class="risk-metric-value ${data.sharpe_ratio > 1 ? 'positive' : data.sharpe_ratio > 0 ? 'warning' : 'negative'}">
                            ${data.sharpe_ratio?.toFixed(2) || '0'}
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Sortino Ratio</div>
                        <div class="risk-metric-value ${data.sortino_ratio > 1 ? 'positive' : data.sortino_ratio > 0 ? 'warning' : 'negative'}">
                            ${data.sortino_ratio?.toFixed(2) || '0'}
                        </div>
                    </div>
                    
                    <!-- Value at Risk -->
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">VaR 95%</div>
                        <div class="risk-metric-value negative">
                            $${data.var_95?.toLocaleString() || '0'}
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">VaR 99%</div>
                        <div class="risk-metric-value negative">
                            $${data.var_99?.toLocaleString() || '0'}
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Max Drawdown</div>
                        <div class="risk-metric-value ${data.max_drawdown > 0.2 ? 'negative' : data.max_drawdown > 0.1 ? 'warning' : 'positive'}">
                            ${(data.max_drawdown * 100)?.toFixed(1) || '0'}%
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Tail Risk</div>
                        <div class="risk-metric-value ${data.tail_risk < -0.1 ? 'negative' : 'warning'}">
                            ${(data.tail_risk * 100)?.toFixed(1) || '0'}%
                        </div>
                    </div>
                    
                    <!-- Concentration Risk -->
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Stock Concentration</div>
                        <div class="risk-metric-value ${data.stock_concentration_risk > 0.3 ? 'negative' : data.stock_concentration_risk > 0.2 ? 'warning' : 'positive'}">
                            ${(data.stock_concentration_risk * 100)?.toFixed(1) || '0'}%
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Sector Concentration</div>
                        <div class="risk-metric-value ${data.sector_concentration_risk > 0.3 ? 'negative' : data.sector_concentration_risk > 0.2 ? 'warning' : 'positive'}">
                            ${(data.sector_concentration_risk * 100)?.toFixed(1) || '0'}%
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Liquidity Risk</div>
                        <div class="risk-metric-value ${data.liquidity_risk > 0.5 ? 'negative' : data.liquidity_risk > 0.3 ? 'warning' : 'positive'}">
                            ${(data.liquidity_risk * 100)?.toFixed(1) || '0'}%
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Correlation Risk</div>
                        <div class="risk-metric-value ${data.correlation_risk > 0.7 ? 'negative' : data.correlation_risk > 0.5 ? 'warning' : 'positive'}">
                            ${(data.correlation_risk * 100)?.toFixed(1) || '0'}%
                        </div>
                    </div>
                    
                    <!-- Options Risk -->
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Delta Exposure</div>
                        <div class="risk-metric-value ${Math.abs(data.delta_exposure) > 100 ? 'warning' : 'positive'}">
                            ${data.delta_exposure?.toFixed(2) || '0'}
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Gamma Risk</div>
                        <div class="risk-metric-value ${Math.abs(data.gamma_risk) > 10 ? 'warning' : 'positive'}">
                            ${data.gamma_risk?.toFixed(2) || '0'}
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Theta Decay</div>
                        <div class="risk-metric-value ${data.theta_decay_risk < -10 ? 'negative' : data.theta_decay_risk < -5 ? 'warning' : 'positive'}">
                            ${data.theta_decay_risk?.toFixed(2) || '0'}
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Vega Risk</div>
                        <div class="risk-metric-value ${Math.abs(data.vega_risk) > 20 ? 'warning' : 'positive'}">
                            ${data.vega_risk?.toFixed(2) || '0'}
                        </div>
                    </div>
                    
                    <!-- Advanced Metrics -->
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Skewness</div>
                        <div class="risk-metric-value ${data.skewness < -1 ? 'negative' : data.skewness > 1 ? 'warning' : 'positive'}">
                            ${data.skewness?.toFixed(2) || '0'}
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Kurtosis</div>
                        <div class="risk-metric-value ${data.kurtosis > 3 ? 'warning' : 'positive'}">
                            ${data.kurtosis?.toFixed(2) || '0'}
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Information Ratio</div>
                        <div class="risk-metric-value ${data.information_ratio > 0.5 ? 'positive' : data.information_ratio > 0 ? 'warning' : 'negative'}">
                            ${data.information_ratio?.toFixed(2) || '0'}
                        </div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="risk-metric-title">Treynor Ratio</div>
                        <div class="risk-metric-value ${data.treynor_ratio > 0.1 ? 'positive' : data.treynor_ratio > 0 ? 'warning' : 'negative'}">
                            ${data.treynor_ratio?.toFixed(2) || '0'}
                        </div>
                    </div>
                </div>
            `;
            
            riskMetrics.innerHTML = html;
        }

        async function runStressTests() {
            const resultsDiv = document.getElementById('stress-test-results');
            resultsDiv.innerHTML = '<div class="loading">Running stress tests...</div>';
            
            try {
                const response = await axios.get('/api/portfolio/scenario/stress-tests');
                displayStressTestResults(response.data.stress_tests);
            } catch (error) {
                console.error('Error running stress tests:', error);
                resultsDiv.innerHTML = '<p class="error">Failed to run stress tests</p>';
            }
        }

        function displayStressTestResults(results) {
            const resultsDiv = document.getElementById('stress-test-results');
            
            if (!results || results.length === 0) {
                resultsDiv.innerHTML = '<p>No stress test results available</p>';
                return;
            }
            
            const html = `
                <div class="stress-test-container">
                    ${results.map((result, index) => {
                        // Determine severity based on P&L impact
                        const pnlPct = Math.abs(result.pnl_pct || 0);
                        let severity = 'low';
                        let severityClass = 'severity-low';
                        if (pnlPct > 15) {
                            severity = 'high';
                            severityClass = 'severity-high';
                        } else if (pnlPct > 8) {
                            severity = 'medium';
                            severityClass = 'severity-medium';
                        }
                        
                        return `
                            <div class="stress-test-scenario">
                                <div class="stress-test-header">
                                    <h3 class="stress-test-title">${result.scenario_name}</h3>
                                    <span class="stress-test-severity ${severityClass}">${severity}</span>
                                </div>
                                
                                <div class="stress-test-content">
                                    <div class="stress-test-metrics">
                                        <div class="stress-test-metric">
                                            <div class="stress-test-metric-label">Portfolio Value</div>
                                            <div class="stress-test-metric-value">$${result.portfolio_value?.toLocaleString() || '0'}</div>
                                        </div>
                                        <div class="stress-test-metric">
                                            <div class="stress-test-metric-label">P&L Impact</div>
                                            <div class="stress-test-metric-value ${result.pnl >= 0 ? 'positive' : 'negative'}">
                                                $${result.pnl?.toLocaleString() || '0'}
                                            </div>
                                        </div>
                                        <div class="stress-test-metric">
                                            <div class="stress-test-metric-label">P&L %</div>
                                            <div class="stress-test-metric-value ${result.pnl_pct >= 0 ? 'positive' : 'negative'}">
                                                ${result.pnl_pct?.toFixed(2) || '0'}%
                                            </div>
                                        </div>
                                        <div class="stress-test-metric">
                                            <div class="stress-test-metric-label">VaR 95%</div>
                                            <div class="stress-test-metric-value negative">
                                                $${result.var_95?.toLocaleString() || '0'}
                                            </div>
                                        </div>
                                        <div class="stress-test-metric">
                                            <div class="stress-test-metric-label">VaR 99%</div>
                                            <div class="stress-test-metric-value negative">
                                                $${result.var_99?.toLocaleString() || '0'}
                                            </div>
                                        </div>
                                        <div class="stress-test-metric">
                                            <div class="stress-test-metric-label">CVaR 95%</div>
                                            <div class="stress-test-metric-value negative">
                                                $${result.cvar_95?.toLocaleString() || '0'}
                                            </div>
                                        </div>
                                        <div class="stress-test-metric">
                                            <div class="stress-test-metric-label">Max Drawdown</div>
                                            <div class="stress-test-metric-value ${result.max_drawdown > 0.2 ? 'negative' : result.max_drawdown > 0.1 ? 'warning' : 'positive'}">
                                                ${(result.max_drawdown * 100)?.toFixed(1) || '0'}%
                                            </div>
                                        </div>
                                        <div class="stress-test-metric">
                                            <div class="stress-test-metric-label">Sharpe Ratio</div>
                                            <div class="stress-test-metric-value ${result.sharpe_ratio > 1 ? 'positive' : result.sharpe_ratio > 0 ? 'warning' : 'negative'}">
                                                ${result.sharpe_ratio?.toFixed(2) || '0'}
                                            </div>
                                        </div>
                                        <div class="stress-test-metric">
                                            <div class="stress-test-metric-label">Delta Exposure</div>
                                            <div class="stress-test-metric-value ${Math.abs(result.delta) > 100 ? 'warning' : 'positive'}">
                                                ${result.delta?.toFixed(2) || '0'}
                                            </div>
                                        </div>
                                        <div class="stress-test-metric">
                                            <div class="stress-test-metric-label">Gamma Risk</div>
                                            <div class="stress-test-metric-value ${Math.abs(result.gamma) > 10 ? 'warning' : 'positive'}">
                                                ${result.gamma?.toFixed(2) || '0'}
                                            </div>
                                        </div>
                                        <div class="stress-test-metric">
                                            <div class="stress-test-metric-label">Theta Decay</div>
                                            <div class="stress-test-metric-value ${result.theta < -10 ? 'negative' : result.theta < -5 ? 'warning' : 'positive'}">
                                                ${result.theta?.toFixed(2) || '0'}
                                            </div>
                                        </div>
                                        <div class="stress-test-metric">
                                            <div class="stress-test-metric-label">Vega Risk</div>
                                            <div class="stress-test-metric-value ${Math.abs(result.vega) > 20 ? 'warning' : 'positive'}">
                                                ${result.vega?.toFixed(2) || '0'}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="stress-test-explanation">
                                        ${result.explanation ? `
                                            <div class="explanation-section">
                                                <div class="explanation-label">Purpose</div>
                                                <div class="explanation-text">${result.explanation.purpose || 'N/A'}</div>
                                            </div>
                                            <div class="explanation-section">
                                                <div class="explanation-label">What Happens</div>
                                                <div class="explanation-text">${result.explanation.what_happens || 'N/A'}</div>
                                            </div>
                                            <div class="explanation-section">
                                                <div class="explanation-label">Key Risks</div>
                                                <div class="explanation-text">${result.explanation.key_risks || 'N/A'}</div>
                                            </div>
                                            <div class="explanation-section">
                                                <div class="explanation-label">What to Look For</div>
                                                <div class="explanation-text">${result.explanation.what_to_look_for || 'N/A'}</div>
                                            </div>
                                            <div class="explanation-section">
                                                <div class="explanation-label">Interpretation</div>
                                                <div class="explanation-text">${result.explanation.interpretation || 'N/A'}</div>
                                            </div>
                                            <div class="explanation-section">
                                                <div class="explanation-label">Historical Context</div>
                                                <div class="explanation-text">${result.explanation.historical_context || 'N/A'}</div>
                                            </div>
                                            <div class="explanation-section">
                                                <div class="explanation-label">Mitigation Strategies</div>
                                                <div class="explanation-text">${result.explanation.mitigation || 'N/A'}</div>
                                            </div>
                                        ` : '<div class="explanation-text">No detailed explanation available for this scenario.</div>'}
                                    </div>
                                </div>
                                
                                <div class="stress-test-chart">
                                    <div class="chart-title">Scenario Impact Visualization</div>
                                    <canvas id="scenarioChart${index}" class="scenario-chart"></canvas>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // Create charts for each scenario
            results.forEach((result, index) => {
                setTimeout(() => {
                    createScenarioChart(`scenarioChart${index}`, result, index);
                }, 100 * index); // Stagger chart creation
            });
        }
        
        function createScenarioChart(canvasId, result, index) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Create a simple bar chart showing key metrics
            const metrics = [
                { label: 'P&L %', value: result.pnl_pct || 0, color: result.pnl_pct >= 0 ? '#059669' : '#dc2626' },
                { label: 'VaR 95%', value: (result.var_95 / result.portfolio_value) * 100 || 0, color: '#dc2626' },
                { label: 'Max DD %', value: (result.max_drawdown || 0) * 100, color: '#d97706' },
                { label: 'Sharpe', value: (result.sharpe_ratio || 0) * 10, color: '#1e3a8a' }
            ];
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: metrics.map(m => m.label),
                    datasets: [{
                        label: 'Impact',
                        data: metrics.map(m => m.value),
                        backgroundColor: metrics.map(m => m.color),
                        borderColor: metrics.map(m => m.color),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${result.scenario_name} - Key Metrics`,
                            font: { size: 14, weight: 'bold' },
                            color: '#1e3a8a'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value',
                                color: '#1e3a8a'
                            }
                        }
                    }
                }
            });
        }

        async function runMonteCarlo() {
            const resultsDiv = document.getElementById('stress-test-results');
            resultsDiv.innerHTML = '<div class="loading">Running Monte Carlo simulation...</div>';
            
            try {
                const response = await axios.get('/api/portfolio/scenario/monte-carlo?num_simulations=1000');
                displayMonteCarloResults(response.data.monte_carlo);
            } catch (error) {
                console.error('Error running Monte Carlo simulation:', error);
                resultsDiv.innerHTML = '<p class="error">Failed to run Monte Carlo simulation</p>';
            }
        }

        function displayMonteCarloResults(data) {
            const resultsDiv = document.getElementById('stress-test-results');
            
            if (data.error) {
                resultsDiv.innerHTML = `<p class="error">Monte Carlo simulation error: ${data.error}</p>`;
                return;
            }
            
            const html = `
                <div class="stress-test-container">
                    <div class="stress-test-scenario">
                        <div class="stress-test-header">
                            <h3 class="stress-test-title">Monte Carlo Simulation Results</h3>
                            <span class="stress-test-severity severity-medium">Simulation</span>
                        </div>
                        
                        <div class="stress-test-content">
                            <div class="stress-test-metrics">
                                <div class="stress-test-metric">
                                    <div class="stress-test-metric-label">Simulations Run</div>
                                    <div class="stress-test-metric-value">${data.num_simulations?.toLocaleString() || '0'}</div>
                                </div>
                                <div class="stress-test-metric">
                                    <div class="stress-test-metric-label">Current Value</div>
                                    <div class="stress-test-metric-value">$${data.current_value?.toLocaleString() || '0'}</div>
                                </div>
                                <div class="stress-test-metric">
                                    <div class="stress-test-metric-label">Mean Value</div>
                                    <div class="stress-test-metric-value">$${data.mean_simulated_value?.toLocaleString() || '0'}</div>
                                </div>
                                <div class="stress-test-metric">
                                    <div class="stress-test-metric-label">VaR 95%</div>
                                    <div class="stress-test-metric-value negative">$${data.var_95?.toLocaleString() || '0'}</div>
                                </div>
                                <div class="stress-test-metric">
                                    <div class="stress-test-metric-label">VaR 99%</div>
                                    <div class="stress-test-metric-value negative">$${data.var_99?.toLocaleString() || '0'}</div>
                                </div>
                                <div class="stress-test-metric">
                                    <div class="stress-test-metric-label">Expected Shortfall 95%</div>
                                    <div class="stress-test-metric-value negative">$${data.expected_shortfall_95?.toLocaleString() || '0'}</div>
                                </div>
                                <div class="stress-test-metric">
                                    <div class="stress-test-metric-label">Probability of Loss</div>
                                    <div class="stress-test-metric-value ${data.probability_of_loss > 0.3 ? 'negative' : data.probability_of_loss > 0.15 ? 'warning' : 'positive'}">
                                        ${(data.probability_of_loss * 100)?.toFixed(1) || '0'}%
                                    </div>
                                </div>
                                <div class="stress-test-metric">
                                    <div class="stress-test-metric-label">Max Loss</div>
                                    <div class="stress-test-metric-value negative">$${data.max_loss?.toLocaleString() || '0'}</div>
                                </div>
                                <div class="stress-test-metric">
                                    <div class="stress-test-metric-label">Standard Deviation</div>
                                    <div class="stress-test-metric-value warning">$${data.std_deviation?.toLocaleString() || '0'}</div>
                                </div>
                                <div class="stress-test-metric">
                                    <div class="stress-test-metric-label">Skewness</div>
                                    <div class="stress-test-metric-value ${data.skewness < -1 ? 'negative' : data.skewness > 1 ? 'warning' : 'positive'}">
                                        ${data.skewness?.toFixed(2) || '0'}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stress-test-explanation">
                                <div class="explanation-section">
                                    <div class="explanation-label">What is Monte Carlo Simulation?</div>
                                    <div class="explanation-text">
                                        Monte Carlo simulation uses random sampling to model the probability of different outcomes in a process that cannot easily be predicted due to the intervention of random variables. It helps assess portfolio risk by running thousands of simulations with different market scenarios.
                                    </div>
                                </div>
                                <div class="explanation-section">
                                    <div class="explanation-label">Key Insights</div>
                                    <div class="explanation-text">
                                        The simulation shows the range of possible portfolio values based on historical volatility patterns. Lower percentiles indicate potential losses, while higher percentiles show upside potential. This helps understand tail risk and extreme scenarios.
                                    </div>
                                </div>
                                <div class="explanation-section">
                                    <div class="explanation-label">How to Interpret</div>
                                    <div class="explanation-text">
                                        â€¢ VaR 95%: 95% confidence that losses won't exceed this amount<br>
                                        â€¢ VaR 99%: 99% confidence that losses won't exceed this amount<br>
                                        â€¢ Expected Shortfall: Average loss when VaR threshold is exceeded<br>
                                        â€¢ Probability of Loss: Chance of ending with less than current value
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stress-test-chart">
                            <div class="chart-title">Monte Carlo Distribution</div>
                            <canvas id="monteCarloChart" class="scenario-chart"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // Create Monte Carlo distribution chart
            setTimeout(() => {
                createMonteCarloChart(data);
            }, 100);
        }
        
        function createMonteCarloChart(data) {
            const canvas = document.getElementById('monteCarloChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Create a bar chart showing key risk metrics
            const metrics = [
                { label: 'VaR 95%', value: Math.abs(data.var_95 || 0), color: '#dc2626' },
                { label: 'VaR 99%', value: Math.abs(data.var_99 || 0), color: '#b91c1c' },
                { label: 'Expected Shortfall', value: Math.abs(data.expected_shortfall_95 || 0), color: '#991b1b' },
                { label: 'Max Loss', value: Math.abs(data.max_loss || 0), color: '#7f1d1d' }
            ];
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: metrics.map(m => m.label),
                    datasets: [{
                        label: 'Risk Amount ($)',
                        data: metrics.map(m => m.value),
                        backgroundColor: metrics.map(m => m.color),
                        borderColor: metrics.map(m => m.color),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Portfolio Risk Metrics',
                            font: { size: 14, weight: 'bold' },
                            color: '#1e3a8a'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Risk Amount ($)',
                                color: '#1e3a8a'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        async function refreshRiskData() {
            await loadRiskData();
            updateRiskCharts();
            showSuccess('Risk data refreshed successfully!');
        }

        // Stock Search Memory
        let stockSearchMemory = JSON.parse(localStorage.getItem('stockSearchMemory') || '[]');

        function saveStockSearch(ticker) {
            const existingIndex = stockSearchMemory.findIndex(item => item.ticker === ticker);
            if (existingIndex !== -1) {
                stockSearchMemory.splice(existingIndex, 1);
            }
            
            stockSearchMemory.unshift({
                ticker: ticker,
                timestamp: Date.now()
            });
            
            if (stockSearchMemory.length > 10) {
                stockSearchMemory = stockSearchMemory.slice(0, 10);
            }
            
            localStorage.setItem('stockSearchMemory', JSON.stringify(stockSearchMemory));
            updateStockSearchMemory();
        }

        function updateStockSearchMemory() {
            const container = document.getElementById('stockSearchMemory');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (stockSearchMemory.length === 0) {
                container.innerHTML = '<span class="no-memory">No recent searches</span>';
                return;
            }
            
            stockSearchMemory.forEach((item, index) => {
                const chip = document.createElement('button');
                chip.className = 'ticker-chip';
                chip.type = 'button';
                chip.setAttribute('data-type', 'stock');
                
                // Add icon
                const icon = document.createElement('svg');
                icon.className = 'ticker-chip-icon';
                icon.innerHTML = '<use href="#icon-trending-up"/>';
                
                // Add text
                const text = document.createElement('span');
                text.textContent = item.ticker;
                
                chip.appendChild(icon);
                chip.appendChild(text);
                
                chip.title = `Click to analyze: ${item.ticker}\nSearched: ${new Date(item.timestamp).toLocaleString()}`;
                chip.onclick = () => {
                    document.getElementById('stockSearch').value = item.ticker;
                    analyzeStock();
                };
                container.appendChild(chip);
            });
        }

        function clearStockSearchMemory() {
            stockSearchMemory = [];
            localStorage.removeItem('stockSearchMemory');
            updateStockSearchMemory();
        }

        // Market Scanner Memory
        let marketScanMemory = JSON.parse(localStorage.getItem('marketScanMemory') || '[]');

        function saveMarketScan(sector, marketCap) {
            const scanKey = `${sector || 'All Sectors'}-${marketCap || 'All Caps'}`;
            const existingIndex = marketScanMemory.findIndex(item => item.key === scanKey);
            if (existingIndex !== -1) {
                marketScanMemory.splice(existingIndex, 1);
            }
            
            marketScanMemory.unshift({
                key: scanKey,
                sector: sector || 'All Sectors',
                marketCap: marketCap || 'All Caps',
                timestamp: Date.now()
            });
            
            if (marketScanMemory.length > 8) {
                marketScanMemory = marketScanMemory.slice(0, 8);
            }
            
            localStorage.setItem('marketScanMemory', JSON.stringify(marketScanMemory));
            updateMarketScanMemory();
        }

        function updateMarketScanMemory() {
            const container = document.getElementById('marketScanMemory');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (marketScanMemory.length === 0) {
                container.innerHTML = '<span class="no-memory">No recent scans</span>';
                return;
            }
            
            marketScanMemory.forEach((item, index) => {
                const chip = document.createElement('button');
                chip.className = 'ticker-chip';
                chip.type = 'button';
                chip.setAttribute('data-type', 'market');
                
                // Add icon
                const icon = document.createElement('svg');
                icon.className = 'ticker-chip-icon';
                icon.innerHTML = '<use href="#icon-filter"/>';
                
                // Add text
                const text = document.createElement('span');
                text.textContent = item.key;
                
                chip.appendChild(icon);
                chip.appendChild(text);
                
                chip.title = `Click to scan: ${item.sector} - ${item.marketCap}\nScanned: ${new Date(item.timestamp).toLocaleString()}`;
                chip.onclick = () => {
                    document.getElementById('sectorFilter').value = item.sector === 'All Sectors' ? '' : item.sector;
                    document.getElementById('marketCapFilter').value = item.marketCap === 'All Caps' ? '' : item.marketCap;
                    scanMarket();
                };
                container.appendChild(chip);
            });
        }

        function clearMarketScanMemory() {
            marketScanMemory = [];
            localStorage.removeItem('marketScanMemory');
            updateMarketScanMemory();
        }

        // Stock Analysis Functions
        async function analyzeStock() {
            const ticker = document.getElementById('stockSearch').value.trim().toUpperCase();
            if (!ticker) {
                showError('Please enter a ticker symbol');
                return;
            }

            // Save to search history
            saveStockSearch(ticker);

            const resultsDiv = document.getElementById('stock-analysis-results');
            resultsDiv.innerHTML = '<div class="loading">Analyzing stock...</div>';

            try {
                // This would call a real API endpoint
                // const response = await axios.get(`/api/stock/analyze/${ticker}`);
                
                // For now, show placeholder content
                setTimeout(() => {
                    resultsDiv.innerHTML = `
                        <div class="placeholder-content">
                            <div class="placeholder-icon">ðŸ“ˆ</div>
                            <h4>Analysis for ${ticker}</h4>
                            <p>Stock analysis functionality coming soon! This will include:</p>
                            <ul class="feature-list">
                                <li>ðŸ“Š Real-time price data and charts</li>
                                <li>ðŸ’° Financial metrics and ratios</li>
                                <li>ðŸ“° News sentiment analysis</li>
                                <li>ðŸŽ¯ Technical indicators and patterns</li>
                            </ul>
                        </div>
                    `;
                }, 1000);
            } catch (error) {
                console.error('Error analyzing stock:', error);
                resultsDiv.innerHTML = '<p class="error">Failed to analyze stock</p>';
            }
        }

        async function scanMarket() {
            const sector = document.getElementById('sectorFilter').value;
            const marketCap = document.getElementById('marketCapFilter').value;
            
            // Save to scan history
            saveMarketScan(sector, marketCap);
            
            const resultsDiv = document.getElementById('market-scanner-results');
            resultsDiv.innerHTML = '<div class="loading">Scanning market...</div>';

            try {
                // This would call a real API endpoint
                // const response = await axios.get('/api/market/scan', { params: { sector, marketCap } });
                
                // For now, show placeholder content
                setTimeout(() => {
                    resultsDiv.innerHTML = `
                        <div class="placeholder-content">
                            <div class="placeholder-icon">ðŸ”</div>
                            <h4>Market Scan Results</h4>
                            <p>Market scanning functionality coming soon! This will include:</p>
                            <ul class="feature-list">
                                <li>ðŸ“Š Filtered stock results based on criteria</li>
                                <li>ðŸŽ¯ Technical pattern recognition</li>
                                <li>ðŸ’° Value and growth opportunities</li>
                                <li>ðŸ“ˆ Momentum and breakout candidates</li>
                            </ul>
                        </div>
                    `;
                }, 1000);
            } catch (error) {
                console.error('Error scanning market:', error);
                resultsDiv.innerHTML = '<p class="error">Failed to scan market</p>';
            }
        }

        // Social Media Functions
        async function testSocialPost() {
            const resultsDiv = document.getElementById('social-results');
            resultsDiv.innerHTML = '<div class="loading">Testing social media post...</div>';

            try {
                // This would call a real API endpoint
                // const response = await axios.post('/api/social/test-post');
                
                // For now, show placeholder content
                setTimeout(() => {
                    resultsDiv.innerHTML = `
                        <div class="placeholder-content">
                            <div class="placeholder-icon">ðŸ¦</div>
                            <h4>Test Post Generated</h4>
                            <p>Social media automation coming soon! This will include:</p>
                            <ul class="feature-list">
                                <li>ðŸ“Š Auto-generated portfolio updates</li>
                                <li>ðŸ“ˆ Market analysis posts</li>
                                <li>ðŸŽ¯ Price alert notifications</li>
                                <li>ðŸ“± Multi-platform posting</li>
                            </ul>
                        </div>
                    `;
                }, 1000);
            } catch (error) {
                console.error('Error testing social post:', error);
                resultsDiv.innerHTML = '<p class="error">Failed to test social post</p>';
            }
        }

        async function scheduleSocialPost() {
            showSuccess('Social media scheduling functionality coming soon!');
        }

        async function viewSocialHistory() {
            showSuccess('Social media history functionality coming soon!');
        }

        function switchTemplateCategory(category) {
            // Remove active class from all categories
            document.querySelectorAll('.template-category').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to selected category
            event.target.classList.add('active');
            
            // This would load different templates based on category
            console.log('Switched to template category:', category);
        }

        // Risk chart functionality
        let riskChart = null;

        async function updateRiskCharts() {
            const chartType = document.getElementById('chartType').value;
            const canvas = document.getElementById('riskChart');
            const ctx = canvas.getContext('2d');

            // Destroy existing chart
            if (riskChart) {
                riskChart.destroy();
            }

            try {
                // Get current risk data
                const response = await axios.get('/api/portfolio/risk-metrics');
                const riskData = response.data;

                // Create chart based on selected type
                switch (chartType) {
                    case 'var':
                        createVaRChart(ctx, riskData);
                        break;
                    case 'greeks':
                        createGreeksChart(ctx, riskData);
                        break;
                    case 'concentration':
                        createConcentrationChart(ctx, riskData);
                        break;
                    case 'volatility':
                        createVolatilityChart(ctx, riskData);
                        break;
                    default:
                        createVaRChart(ctx, riskData);
                }
            } catch (error) {
                console.error('Error updating risk charts:', error);
                ctx.fillStyle = '#1e3a8a';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Error loading chart data', canvas.width / 2, canvas.height / 2);
            }
        }

        function createVaRChart(ctx, riskData) {
            // Simulate VaR data for different confidence levels
            const confidenceLevels = ['90%', '95%', '99%'];
            const varValues = [
                riskData.portfolio_value * -0.05,  // 90% VaR
                riskData.portfolio_value * -0.08,  // 95% VaR
                riskData.portfolio_value * -0.12   // 99% VaR
            ];

            riskChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: confidenceLevels,
                    datasets: [{
                        label: 'Value at Risk ($)',
                        data: varValues,
                        backgroundColor: ['#dc2626', '#b91c1c', '#7f1d1d'],
                        borderColor: ['#ef4444', '#dc2626', '#991b1b'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Value at Risk Analysis',
                            font: { size: 16, weight: 'bold' },
                            color: '#1e3a8a'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Potential Loss ($)',
                                color: '#1e3a8a'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Confidence Level',
                                color: '#1e3a8a'
                            }
                        }
                    }
                }
            });
        }

        function createGreeksChart(ctx, riskData) {
            const greeks = riskData.greeks || {};
            const greekNames = ['Delta', 'Gamma', 'Theta', 'Vega'];
            const greekValues = [
                greeks.total_delta || 0,
                greeks.total_gamma || 0,
                greeks.total_theta || 0,
                greeks.total_vega || 0
            ];

            riskChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: greekNames,
                    datasets: [{
                        label: 'Portfolio Greeks',
                        data: greekValues,
                        backgroundColor: 'rgba(30, 58, 138, 0.2)',
                        borderColor: '#1e3a8a',
                        borderWidth: 2,
                        pointBackgroundColor: '#d4af37',
                        pointBorderColor: '#1e3a8a',
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Portfolio Greeks Exposure',
                            font: { size: 16, weight: 'bold' },
                            color: '#1e3a8a'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Greek Value',
                                color: '#1e3a8a'
                            }
                        }
                    }
                }
            });
        }

        function createConcentrationChart(ctx, riskData) {
            // Simulate position concentration data
            const positions = [
                { name: 'AAPL', value: 17550, percentage: 35.1 },
                { name: 'TSLA', value: 12265, percentage: 24.5 },
                { name: 'GOOGL Call', value: 620, percentage: 1.2 },
                { name: 'Cash', value: 19565, percentage: 39.1 }
            ];

            riskChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: positions.map(p => p.name),
                    datasets: [{
                        data: positions.map(p => p.percentage),
                        backgroundColor: [
                            '#1e3a8a',
                            '#1e40af',
                            '#d4af37',
                            '#64748b'
                        ],
                        borderColor: '#fefefe',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Portfolio Concentration',
                            font: { size: 16, weight: 'bold' },
                            color: '#1e3a8a'
                        },
                        legend: {
                            display: true,
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const position = positions[context.dataIndex];
                                    return `${position.name}: ${position.percentage}% ($${position.value.toLocaleString()})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createVolatilityChart(ctx, riskData) {
            // Simulate volatility data over time
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
            const portfolioVol = [0.18, 0.22, 0.19, 0.25, 0.21];
            const marketVol = [0.16, 0.18, 0.17, 0.20, 0.19];

            riskChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Portfolio Volatility',
                        data: portfolioVol,
                        borderColor: '#1e3a8a',
                        backgroundColor: 'rgba(30, 58, 138, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Market Volatility',
                        data: marketVol,
                        borderColor: '#d4af37',
                        backgroundColor: 'rgba(212, 175, 55, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Volatility Analysis (5-Day)',
                            font: { size: 16, weight: 'bold' },
                            color: '#1e3a8a'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Volatility (%)',
                                color: '#1e3a8a'
                            },
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Trading Days',
                                color: '#1e3a8a'
                            }
                        }
                    }
                }
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const addModal = document.getElementById('addPositionModal');
            const tradeModal = document.getElementById('tradeModal');
            
            if (event.target === addModal) {
                closeAddPositionModal();
            } else if (event.target === tradeModal) {
                closeTradeModal();
            }
        }

        // Option Selection Functions
        let selectedOptions = [];

        function updateSelectedOptions() {
            const container = document.getElementById('selectedOptionsList');
            container.innerHTML = '';
            
            selectedOptions.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'selected-option';
                div.innerHTML = `
                    <span>${option.ticker} ${option.strike_price}${option.contract_type.toUpperCase()} x${option.quantity}</span>
                    <button class="btn btn-sm btn-danger" onclick="removeOption(${index})">Remove</button>
                `;
                container.appendChild(div);
            });
        }

        function removeOption(index) {
            selectedOptions.splice(index, 1);
            updateSelectedOptions();
            updateStrategyMetrics();
            
            if (selectedOptions.length === 0) {
                hideStrategyAnalysis();
            }
        }

        function updateStrategyMetrics() {
            let totalDelta = 0;
            let totalGamma = 0;
            let totalTheta = 0;
            let totalVega = 0;
            let totalCost = 0;
            
            selectedOptions.forEach(option => {
                // Calculate Greeks for each option
                const greeks = calculateGreeks(option);
                totalDelta += greeks.delta * option.quantity;
                totalGamma += greeks.gamma * option.quantity;
                totalTheta += greeks.theta * option.quantity;
                totalVega += greeks.vega * option.quantity;
                totalCost += option.current_price * option.quantity * 100;
            });
            
            document.getElementById('totalDelta').textContent = totalDelta.toFixed(3);
            document.getElementById('totalGamma').textContent = totalGamma.toFixed(3);
            document.getElementById('totalTheta').textContent = totalTheta.toFixed(3);
            document.getElementById('totalVega').textContent = totalVega.toFixed(3);
            document.getElementById('totalCost').textContent = `$${totalCost.toFixed(2)}`;
        }

        function calculateGreeks(option) {
            // Simplified Greeks calculation (in production, use the API)
            const S = currentOptionsData?.current_price || 100;
            const K = option.strike_price;
            const T = 30 / 365; // 30 days
            const r = 0.05; // 5% risk-free rate
            const sigma = 0.25; // 25% IV
            
            const d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
            const d2 = d1 - sigma * Math.sqrt(T);
            
            const delta = option.contract_type === 'call' ? 
                normalCDF(d1) : normalCDF(d1) - 1;
            const gamma = normalPDF(d1) / (S * sigma * Math.sqrt(T));
            const theta = -S * normalPDF(d1) * sigma / (2 * Math.sqrt(T)) - 
                r * K * Math.exp(-r * T) * normalCDF(d2);
            const vega = S * normalPDF(d1) * Math.sqrt(T) / 100;
            
            return { delta, gamma, theta, vega };
        }

        function normalCDF(x) {
            return 0.5 * (1 + erf(x / Math.sqrt(2)));
        }

        function normalPDF(x) {
            return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
        }

        function erf(x) {
            // Approximation of error function
            const a1 =  0.254829592;
            const a2 = -0.284496736;
            const a3 =  1.421413741;
            const a4 = -1.453152027;
            const a5 =  1.061405429;
            const p  =  0.3275911;
            
            const sign = x >= 0 ? 1 : -1;
            x = Math.abs(x);
            
            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
            
            return sign * y;
        }

        function showStrategyAnalysis() {
            document.getElementById('strategyAnalysis').style.display = 'block';
        }

        function hideStrategyAnalysis() {
            document.getElementById('strategyAnalysis').style.display = 'none';
        }

        function analyzeStrategy() {
            if (selectedOptions.length === 0) {
                showError('Please select at least one option');
                return;
            }
            
            const strategyData = {
                ticker: currentOptionsData.ticker,
                strategy_type: selectedOptions.length === 1 ? 'single' : 'spread',
                options: selectedOptions
            };
            
            fetch('/api/options/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(strategyData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                // Update strategy metrics with detailed analysis
                const metrics = data.strategy_metrics;
                document.getElementById('maxProfit').textContent = `$${metrics.max_profit.toFixed(2)}`;
                document.getElementById('maxLoss').textContent = `$${metrics.max_loss.toFixed(2)}`;
                document.getElementById('breakeven').textContent = metrics.breakeven_points.map(bp => `$${bp.toFixed(2)}`).join(', ');
                
                showSuccess('Strategy analyzed successfully');
            })
            .catch(error => {
                console.error('Error analyzing strategy:', error);
                showError('Failed to analyze strategy');
            });
        }

        function clearSelection() {
            selectedOptions = [];
            updateSelectedOptions();
            updateStrategyMetrics();
            hideStrategyAnalysis();
        }

        function addToPortfolio() {
            if (selectedOptions.length === 0) {
                showError('Please select at least one option');
                return;
            }
            
            // For now, just show a message
            showSuccess(`Would add ${selectedOptions.length} option(s) to portfolio`);
            // In production, this would call the portfolio API to add positions
        }



        // Portfolio-based recommendation functions
        function loadCoveredCallRecommendations() {
            const container = document.getElementById('ccRecommendations');
            const loading = document.getElementById('ccLoading');
            const table = document.getElementById('ccTable');
            
            container.style.display = 'block';
            loading.style.display = 'block';
            table.style.display = 'none';
            
            fetch('/api/options/recommendations/covered-calls')
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`Server error (${response.status}): ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    loading.style.display = 'none';
                    
                    console.log('CC Recommendations data:', data);
                    
                    if (data.error) {
                        showError(`Error: ${data.error}`);
                        return;
                    }
                    
                    if (data.detail) {
                        showError(`Error: ${data.detail}`);
                        return;
                    }
                    
                    if (data.recommendations && data.recommendations.length > 0) {
                        console.log('First recommendation:', data.recommendations[0]);
                        displayCCRecommendations(data.recommendations);
                        table.style.display = 'block';
                    } else if (data.message) {
                        showInfo(data.message);
                    } else {
                        showInfo('No covered call opportunities found in your portfolio');
                    }
                })
                .catch(error => {
                    loading.style.display = 'none';
                    console.error('Error loading CC recommendations:', error);
                    showError(`Failed to load covered call recommendations: ${error.message}`);
                });
        }

        let expandedRows = new Set();

        function displayCCRecommendations(recommendations) {
            const tbody = document.getElementById('ccTableBody');
            const tableInfo = document.getElementById('ccTableInfo');
            tbody.innerHTML = '';
            expandedRows.clear();
            
            // Store recommendations for expansion
            window.ccRecommendations = recommendations;
            
            // Update table info
            tableInfo.textContent = `Found ${recommendations.length} covered call opportunities (click any row to expand details)`;
            
            recommendations.forEach((rec, index) => {
                // Determine probability color
                const probClass = rec.probability_of_profit > 0.7 ? 'positive' : (rec.probability_of_profit < 0.5 ? 'negative' : '');
                
                // Main row
                const row = document.createElement('tr');
                row.id = `cc-row-${index}`;
                row.className = 'cc-main-row';
                row.style.cursor = 'pointer';
                row.title = 'Click to expand details';
                row.onclick = () => toggleRowExpansion(index);
                
                row.innerHTML = `
                    <td><span class="expand-icon" id="expand-icon-${index}">â–¶</span></td>
                    <td><strong>${rec.ticker}</strong></td>
                    <td>${rec.contracts_available}</td>
                    <td>$${rec.current_stock_price.toFixed(2)}</td>
                    <td>$${rec.strike_price.toFixed(2)}</td>
                    <td>$${rec.premium.toFixed(2)}</td>
                    <td>${rec.expiration_date}</td>
                    <td>${rec.days_to_expiration}</td>
                    <td class="${rec.delta > 0 ? 'positive' : 'negative'}">${rec.delta.toFixed(3)}</td>
                    <td>${(rec.implied_volatility * 100).toFixed(1)}%</td>
                    <td class="positive">$${rec.max_profit_per_contract.toFixed(2)}</td>
                    <td class="positive">${rec.roi.toFixed(2)}%</td>
                    <td class="positive">${rec.annualized_return.toFixed(1)}%</td>
                    <td class="${probClass}">${(rec.probability_of_profit * 100).toFixed(1)}%</td>
                    <td><span class="score">${rec.score.toFixed(0)}</span></td>
                    <td onclick="event.stopPropagation()">
                        <button class="btn btn-sm btn-success" onclick="selectCCRecommendation('${rec.ticker}', ${rec.strike_price}, '${rec.expiration_date}', ${rec.premium})">
                            Select
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Expandable detail row
                const detailRow = document.createElement('tr');
                detailRow.id = `cc-detail-${index}`;
                detailRow.className = 'cc-detail-row';
                detailRow.style.display = 'none';
                
                const bbPosition = (rec.bb_position * 100).toFixed(0);
                const rsiClass = rec.rsi > 70 ? 'negative' : (rec.rsi < 30 ? 'positive' : '');
                const breakdown = rec.score_breakdown;
                
                // Debug: log the breakdown to see what's there
                if (index === 0) {
                    console.log('Score breakdown for first rec:', breakdown);
                }
                
                if (!breakdown || !breakdown.weights) {
                    console.error('Missing score_breakdown or weights for recommendation:', rec);
                    return; // Skip this row if data is missing
                }
                
                const weights = breakdown.weights;
                
                detailRow.innerHTML = `
                    <td colspan="16" style="padding: 1.5rem; background: #f8fafc;">
                        <div class="row-detail-container">
                            <div class="detail-section">
                                <h5>
                                    <svg class="icon icon-sm icon-inline" style="stroke: var(--primary-blue);">
                                        <use href="#icon-pie-chart"/>
                                    </svg>
                                    Score Breakdown (Total: ${rec.score.toFixed(1)}/100)
                                </h5>
                                <div class="score-components-inline">
                                    <!-- Ordered by weight: highest to lowest -->
                                    <div class="score-component">
                                        <div class="component-label">
                                            <svg class="icon icon-sm icon-inline" style="stroke: #ef4444;">
                                                <use href="#icon-target"/>
                                            </svg>
                                            Probability of Profit (${(weights.probability * 100).toFixed(0)}%)
                                        </div>
                                        <div class="component-bar">
                                            <div class="component-fill" style="width: ${breakdown.probability_score}%; background: #ef4444;"></div>
                                        </div>
                                        <div class="component-value">${breakdown.probability_score.toFixed(1)}/100 Ã— ${(weights.probability * 100).toFixed(0)}% = <strong>${(breakdown.probability_score * weights.probability).toFixed(1)}</strong></div>
                                    </div>
                                    <div class="score-component">
                                        <div class="component-label">
                                            <svg class="icon icon-sm icon-inline" style="stroke: #10b981;">
                                                <use href="#icon-dollar"/>
                                            </svg>
                                            ROI (${(weights.roi * 100).toFixed(0)}%)
                                        </div>
                                        <div class="component-bar">
                                            <div class="component-fill" style="width: ${breakdown.roi_score}%; background: #10b981;"></div>
                                        </div>
                                        <div class="component-value">${breakdown.roi_score.toFixed(1)}/100 Ã— ${(weights.roi * 100).toFixed(0)}% = <strong>${(breakdown.roi_score * weights.roi).toFixed(1)}</strong></div>
                                    </div>
                                    <div class="score-component">
                                        <div class="component-label">
                                            <svg class="icon icon-sm icon-inline" style="stroke: #3b82f6;">
                                                <use href="#icon-technical"/>
                                            </svg>
                                            Technical Analysis (${(weights.technical * 100).toFixed(0)}%)
                                        </div>
                                        <div class="component-bar">
                                            <div class="component-fill" style="width: ${breakdown.technical_score}%; background: #3b82f6;"></div>
                                        </div>
                                        <div class="component-value">${breakdown.technical_score.toFixed(1)}/100 Ã— ${(weights.technical * 100).toFixed(0)}% = <strong>${(breakdown.technical_score * weights.technical).toFixed(1)}</strong></div>
                                    </div>
                                    <div class="score-component">
                                        <div class="component-label">
                                            <svg class="icon icon-sm icon-inline" style="stroke: #8b5cf6;">
                                                <use href="#icon-greeks"/>
                                            </svg>
                                            Greeks Analysis (${(weights.greeks * 100).toFixed(0)}%)
                                        </div>
                                        <div class="component-bar">
                                            <div class="component-fill" style="width: ${breakdown.greeks_score}%; background: #8b5cf6;"></div>
                                        </div>
                                        <div class="component-value">${breakdown.greeks_score.toFixed(1)}/100 Ã— ${(weights.greeks * 100).toFixed(0)}% = <strong>${(breakdown.greeks_score * weights.greeks).toFixed(1)}</strong></div>
                                    </div>
                                    <div class="score-component">
                                        <div class="component-label">
                                            <svg class="icon icon-sm icon-inline" style="stroke: #a855f7;">
                                                <use href="#icon-volatility"/>
                                            </svg>
                                            IVR (${(weights.ivr * 100).toFixed(0)}%)
                                        </div>
                                        <div class="component-bar">
                                            <div class="component-fill" style="width: ${breakdown.ivr_score}%; background: #a855f7;"></div>
                                        </div>
                                        <div class="component-value">${breakdown.ivr_score.toFixed(1)}/100 Ã— ${(weights.ivr * 100).toFixed(0)}% = <strong>${(breakdown.ivr_score * weights.ivr).toFixed(1)}</strong> ${rec.ivr ? '(IVR: ' + rec.ivr.toFixed(1) + '%)' : '(no IVR data)'}</div>
                                    </div>
                                    <div class="score-component">
                                        <div class="component-label">
                                            <svg class="icon icon-sm icon-inline" style="stroke: #06b6d4;">
                                                <use href="#icon-dollar"/>
                                            </svg>
                                            Liquidity (${(weights.liquidity * 100).toFixed(0)}%)
                                        </div>
                                        <div class="component-bar">
                                            <div class="component-fill" style="width: ${breakdown.liquidity_score}%; background: #06b6d4;"></div>
                                        </div>
                                        <div class="component-value">${breakdown.liquidity_score.toFixed(1)}/100 Ã— ${(weights.liquidity * 100).toFixed(0)}% = <strong>${(breakdown.liquidity_score * weights.liquidity).toFixed(1)}</strong></div>
                                    </div>
                                    <div class="score-component">
                                        <div class="component-label">
                                            <svg class="icon icon-sm icon-inline" style="stroke: #f59e0b;">
                                                <use href="#icon-resistance"/>
                                            </svg>
                                            Resistance (${(weights.resistance * 100).toFixed(0)}%)
                                        </div>
                                        <div class="component-bar">
                                            <div class="component-fill" style="width: ${breakdown.resistance_score}%; background: #f59e0b;"></div>
                                        </div>
                                        <div class="component-value">${breakdown.resistance_score.toFixed(1)}/100 Ã— ${(weights.resistance * 100).toFixed(0)}% = <strong>${(breakdown.resistance_score * weights.resistance).toFixed(1)}</strong></div>
                                    </div>
                                    <div class="score-component">
                                        <div class="component-label">
                                            <svg class="icon icon-sm icon-inline" style="stroke: #059669;">
                                                <use href="#icon-dollar"/>
                                            </svg>
                                            Cash Required (${(weights.cash_required * 100).toFixed(0)}%)
                                        </div>
                                        <div class="component-bar">
                                            <div class="component-fill" style="width: ${breakdown.cash_required_score}%; background: #059669;"></div>
                                        </div>
                                        <div class="component-value">${breakdown.cash_required_score.toFixed(1)}/100 Ã— ${(weights.cash_required * 100).toFixed(0)}% = <strong>${(breakdown.cash_required_score * weights.cash_required).toFixed(1)}</strong></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h5>ðŸ“ˆ Technical Indicators</h5>
                                <div class="details-grid">
                                    <div>
                                        <strong>RSI:</strong> <span class="${rsiClass}">${rec.rsi.toFixed(1)}</span><br>
                                        <small>${rec.rsi > 70 ? 'âœ“ Overbought - Good for selling CCs' : rec.rsi < 30 ? 'âœ— Oversold - Bad for selling CCs' : 'Neutral'}</small>
                                    </div>
                                    <div>
                                        <strong>MACD:</strong> ${rec.macd.toFixed(2)} / Signal: ${rec.macd_signal.toFixed(2)}<br>
                                        <small>${rec.macd_histogram > 0 ? 'âœ— Bullish - Bad for selling CCs' : 'âœ“ Bearish - Good for selling CCs'}</small>
                                    </div>
                                    <div>
                                        <strong>Bollinger Bands:</strong> ${bbPosition}% position<br>
                                        <small>${rec.bb_position > 0.8 ? 'âœ“ Upper band - Good for selling CCs' : rec.bb_position < 0.2 ? 'âœ— Lower band - Bad for selling CCs' : 'Middle range'}</small>
                                    </div>
                                    <div>
                                        <strong>Support/Resistance:</strong><br>
                                        <small>Support: $${rec.support_level.toFixed(2)} | Resistance: $${rec.resistance_level.toFixed(2)}</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h5>ðŸ“Š Greeks & Metrics</h5>
                                <div class="details-grid">
                                    <div>
                                        <strong>Gamma:</strong> ${rec.gamma.toFixed(4)}<br>
                                        <small>${rec.gamma < 0.01 ? 'âœ“ Low acceleration risk' : rec.gamma > 0.05 ? 'âœ— High acceleration risk' : 'Normal'}</small>
                                    </div>
                                    <div>
                                        <strong>Theta:</strong> ${rec.theta.toFixed(4)}<br>
                                        <small>${Math.abs(rec.theta) > 0.1 ? 'âœ“ Good time decay' : 'Low time decay'}</small>
                                    </div>
                                    <div>
                                        <strong>Vega:</strong> ${rec.vega.toFixed(3)}<br>
                                        <small>${rec.vega < 0.1 ? 'âœ“ Low volatility risk' : rec.vega > 0.3 ? 'âœ— High volatility risk' : 'Normal'}</small>
                                    </div>
                                    <div>
                                        <strong>Volume:</strong> ${rec.volume}<br>
                                        <small>${rec.volume > 100 ? 'âœ“ Excellent liquidity' : rec.volume > 10 ? 'Good liquidity' : 'âœ— Low volume'}</small>
                                    </div>
                                    <div>
                                        <strong>Open Interest:</strong> ${rec.open_interest}<br>
                                        <small>${rec.open_interest > 500 ? 'âœ“ Excellent' : rec.open_interest > 100 ? 'âœ“ Good' : 'âœ— Low'}</small>
                                    </div>
                                    <div>
                                        <strong>Moneyness:</strong> ${rec.moneyness}<br>
                                        <small>${rec.moneyness === 'OTM' ? 'âœ“ Preferred for CCs' : rec.moneyness === 'ATM' ? 'At the money' : 'In the money'}</small>
                                    </div>
                                    <div>
                                        <strong>Max Loss:</strong> <span class="negative">$${rec.max_loss_per_contract.toFixed(2)}</span><br>
                                        <small>If stock drops to $0</small>
                                    </div>
                                    <div>
                                        <strong>Breakeven:</strong> $${rec.breakeven.toFixed(2)}<br>
                                        <small>Stock price minus premium</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(detailRow);
            });
        }
        
        function toggleRowExpansion(index) {
            const detailRow = document.getElementById(`cc-detail-${index}`);
            const icon = document.getElementById(`expand-icon-${index}`);
            
            if (expandedRows.has(index)) {
                // Collapse
                detailRow.style.display = 'none';
                icon.textContent = 'â–¶';
                expandedRows.delete(index);
            } else {
                // Expand
                detailRow.style.display = 'table-row';
                icon.textContent = 'â–¼';
                expandedRows.add(index);
            }
        }
        
        function showScoreBreakdown(index) {
            const rec = window.ccRecommendations[index];
            if (!rec || !rec.score_breakdown) {
                showError('Score breakdown not available');
                return;
            }
            
            const breakdown = rec.score_breakdown;
            const weights = breakdown.weights;
            
            const content = `
                <div class="score-breakdown-container">
                    <div class="score-header">
                        <h4>${rec.ticker} ${rec.strike_price}C - ${rec.expiration_date}</h4>
                        <div class="score-total">Total Score: <span class="score-large">${breakdown.overall_score.toFixed(1)}</span> / 100</div>
                    </div>
                    
                    <div class="score-components">
                        <h5>Score Components:</h5>
                        <div class="score-item">
                            <span class="score-label">
                                <svg class="icon icon-sm icon-inline" style="stroke: #3b82f6;">
                                    <use href="#icon-technical"/>
                                </svg>
                                Technical Analysis:
                            </span>
                            <div class="score-bar-container">
                                <div class="score-bar" style="width: ${breakdown.technical_score}%"></div>
                            </div>
                            <span class="score-value">${breakdown.technical_score.toFixed(1)}/100 Ã— ${(weights.technical * 100).toFixed(0)}% = ${(breakdown.technical_score * weights.technical).toFixed(1)}</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">
                                <svg class="icon icon-sm icon-inline" style="stroke: #8b5cf6;">
                                    <use href="#icon-greeks"/>
                                </svg>
                                Greeks Analysis:
                            </span>
                            <div class="score-bar-container">
                                <div class="score-bar" style="width: ${breakdown.greeks_score}%"></div>
                            </div>
                            <span class="score-value">${breakdown.greeks_score.toFixed(1)}/100 Ã— ${(weights.greeks * 100).toFixed(0)}% = ${(breakdown.greeks_score * weights.greeks).toFixed(1)}</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">
                                <svg class="icon icon-sm icon-inline" style="stroke: #06b6d4;">
                                    <use href="#icon-dollar"/>
                                </svg>
                                Liquidity:
                            </span>
                            <div class="score-bar-container">
                                <div class="score-bar" style="width: ${breakdown.liquidity_score}%"></div>
                            </div>
                            <span class="score-value">${breakdown.liquidity_score.toFixed(1)}/100 Ã— ${(weights.liquidity * 100).toFixed(0)}% = ${(breakdown.liquidity_score * weights.liquidity).toFixed(1)}</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">
                                <svg class="icon icon-sm icon-inline" style="stroke: #f59e0b;">
                                    <use href="#icon-resistance"/>
                                </svg>
                                Resistance Analysis:
                            </span>
                            <div class="score-bar-container">
                                <div class="score-bar" style="width: ${breakdown.resistance_score}%"></div>
                            </div>
                            <span class="score-value">${breakdown.resistance_score.toFixed(1)}/100 Ã— ${(weights.resistance * 100).toFixed(0)}% = ${(breakdown.resistance_score * weights.resistance).toFixed(1)}</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">
                                <svg class="icon icon-sm icon-inline" style="stroke: #ef4444;">
                                    <use href="#icon-target"/>
                                </svg>
                                Probability of Profit:
                            </span>
                            <div class="score-bar-container">
                                <div class="score-bar" style="width: ${breakdown.probability_score}%"></div>
                            </div>
                            <span class="score-value">${breakdown.probability_score.toFixed(1)}/100 Ã— ${(weights.probability * 100).toFixed(0)}% = ${(breakdown.probability_score * weights.probability).toFixed(1)}</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">
                                <svg class="icon icon-sm icon-inline" style="stroke: #10b981;">
                                    <use href="#icon-dollar"/>
                                </svg>
                                ROI:
                            </span>
                            <div class="score-bar-container">
                                <div class="score-bar" style="width: ${breakdown.roi_score}%"></div>
                            </div>
                            <span class="score-value">${breakdown.roi_score.toFixed(1)}/100 Ã— ${(weights.roi * 100).toFixed(0)}% = ${(breakdown.roi_score * weights.roi).toFixed(1)}</span>
                        </div>
                    </div>
                    
                    <div class="score-details">
                        <h5>Technical Details:</h5>
                        <div class="details-grid">
                            <div><strong>RSI:</strong> ${rec.rsi.toFixed(1)} ${rec.rsi > 70 ? '(Overbought âœ“)' : rec.rsi < 30 ? '(Oversold âœ—)' : '(Neutral)'}</div>
                            <div><strong>MACD:</strong> ${rec.macd.toFixed(2)} ${rec.macd_histogram > 0 ? '(Bullish âœ—)' : '(Bearish âœ“)'}</div>
                            <div><strong>BB Position:</strong> ${(rec.bb_position * 100).toFixed(0)}% ${rec.bb_position > 0.8 ? '(Upper âœ“)' : rec.bb_position < 0.2 ? '(Lower âœ—)' : '(Middle)'}</div>
                            <div><strong>Delta:</strong> ${rec.delta.toFixed(3)} ${0.15 <= Math.abs(rec.delta) && Math.abs(rec.delta) <= 0.35 ? '(Sweet spot âœ“)' : ''}</div>
                            <div><strong>Volume:</strong> ${rec.volume} ${rec.volume > 100 ? '(Good âœ“)' : rec.volume > 10 ? '(OK)' : '(Low âœ—)'}</div>
                            <div><strong>Open Interest:</strong> ${rec.open_interest} ${rec.open_interest > 500 ? '(Excellent âœ“)' : rec.open_interest > 100 ? '(Good âœ“)' : '(Low âœ—)'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('scoreBreakdownContent').innerHTML = content;
            document.getElementById('scoreBreakdownModal').style.display = 'block';
        }
        
        function closeScoreBreakdownModal() {
            document.getElementById('scoreBreakdownModal').style.display = 'none';
        }

        // Ticker Memory System
        let cspTickerMemory = JSON.parse(localStorage.getItem('cspTickerMemory') || '[]');

        // Migration function to convert old format to new individual ticker format
        function migrateCSPTickerMemory() {
            if (cspTickerMemory.length === 0) return;
            
            // Check if we have old format (with 'tickers' and 'displayText' properties)
            const hasOldFormat = cspTickerMemory.some(item => item.tickers || item.displayText);
            
            if (hasOldFormat) {
                console.log('ðŸ”„ Migrating CSP ticker memory to individual ticker format...');
                const newMemory = [];
                
                cspTickerMemory.forEach(item => {
                    if (item.tickers && item.tickers !== 'Automatic Selection') {
                        // Split the old combined ticker string into individual tickers
                        const tickerList = item.tickers.split(/[,\s]+/).filter(ticker => ticker.trim() !== '');
                        tickerList.forEach(ticker => {
                            const cleanTicker = ticker.trim().toUpperCase();
                            if (cleanTicker && !newMemory.find(t => t.ticker === cleanTicker)) {
                                newMemory.push({
                                    ticker: cleanTicker,
                                    timestamp: item.timestamp || new Date().toISOString()
                                });
                            }
                        });
                    }
                });
                
                cspTickerMemory = newMemory.slice(0, 20); // Keep only last 20
                localStorage.setItem('cspTickerMemory', JSON.stringify(cspTickerMemory));
                console.log('âœ… Migration complete!', cspTickerMemory);
            }
        }

        function saveCSPTickerToMemory(tickers) {
            if (!tickers || tickers.trim() === '') return;
            
            // Split tickers by comma and space, then process each individual ticker
            const tickerList = tickers.split(/[,\s]+/).filter(ticker => ticker.trim() !== '');
            
            tickerList.forEach(ticker => {
                const cleanTicker = ticker.trim().toUpperCase();
                if (!cleanTicker) return;
                
                // Remove if already exists and add to beginning
                cspTickerMemory = cspTickerMemory.filter(item => item.ticker !== cleanTicker);
                cspTickerMemory.unshift({
                    ticker: cleanTicker,
                    timestamp: new Date().toISOString()
                });
            });
            
            // Keep only last 20 individual tickers
            cspTickerMemory = cspTickerMemory.slice(0, 20);
            
            // Save to localStorage
            localStorage.setItem('cspTickerMemory', JSON.stringify(cspTickerMemory));
            
            // Update UI
            updateCSPTickerMemoryDisplay();
        }

        function updateCSPTickerMemoryDisplay() {
            const container = document.getElementById('cspTickerMemory');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (cspTickerMemory.length === 0) {
                container.innerHTML = '<span class="no-memory">No recent searches</span>';
                return;
            }
            
            cspTickerMemory.forEach((item, index) => {
                const chip = document.createElement('button');
                chip.className = 'ticker-chip';
                chip.type = 'button';
                chip.setAttribute('data-type', 'csp');
                
                // Add icon
                const icon = document.createElement('svg');
                icon.className = 'ticker-chip-icon';
                icon.innerHTML = '<use href="#icon-target"/>';
                
                // Add text
                const text = document.createElement('span');
                text.textContent = item.ticker;
                
                chip.appendChild(icon);
                chip.appendChild(text);
                
                chip.title = `Click to search: ${item.ticker}\nSearched: ${new Date(item.timestamp).toLocaleString()}`;
                chip.onclick = () => {
                    const input = document.getElementById('cspTickers');
                    const currentValue = input.value.trim();
                    
                    if (currentValue === '') {
                        input.value = item.ticker;
                    } else {
                        // Add to existing tickers if not already present
                        const tickers = currentValue.split(/[,\s]+/).map(t => t.trim().toUpperCase());
                        if (!tickers.includes(item.ticker)) {
                            input.value = currentValue + ', ' + item.ticker;
                        }
                    }
                    loadCSPRecommendations();
                };
                container.appendChild(chip);
            });
        }

        function clearCSPTickerMemory() {
            cspTickerMemory = [];
            localStorage.removeItem('cspTickerMemory');
            updateCSPTickerMemoryDisplay();
            console.log('ðŸ—‘ï¸ CSP ticker memory cleared');
        }

        // Debug function to check memory format
        function debugCSPTickerMemory() {
            console.log('ðŸ” CSP Ticker Memory Debug:');
            console.log('Memory array:', cspTickerMemory);
            console.log('Array length:', cspTickerMemory.length);
            if (cspTickerMemory.length > 0) {
                console.log('First item structure:', Object.keys(cspTickerMemory[0]));
                console.log('First item:', cspTickerMemory[0]);
            }
        }

        function loadCSPRecommendations() {
            const tickersInput = document.getElementById('cspTickers').value.trim();
            
            // Parse tickers if provided, otherwise send empty string for automatic selection
            let tickers = '';
            if (tickersInput) {
                // Split by both commas and spaces, then clean up
                const parsedTickers = tickersInput
                    .split(/[,\s]+/)  // Split by commas or spaces (one or more)
                    .map(t => t.trim().toUpperCase())
                    .filter(t => t && t.length > 0);  // Remove empty strings
                
                if (parsedTickers.length === 0) {
                    showError('Please enter valid ticker symbols');
                    return;
                }
                tickers = parsedTickers.join(',');
            }
            
            // Save to memory
            saveCSPTickerToMemory(tickers);
            
            // Call CSP API
            callCSPAPI(tickers, 'Analyzing tickers for best cash secured puts...');
        }

        function loadCSPFromWatchlist() {
            // Get recent searches from memory
            const recentTickers = cspTickerMemory.map(item => item.ticker);
            const tickersString = recentTickers.join(',');
            
            if (tickersString) {
                // Save to memory
                saveCSPTickerToMemory(tickersString);
                
                // Call CSP API with watchlist flag
                callCSPAPI(tickersString, 'Analyzing watchlist and recent searches for best CSPs...', true);
            } else {
                // No recent searches, just analyze iv_history stocks
                callCSPAPI('', 'Analyzing popular/volatile stocks from database for best CSPs...', true);
            }
        }

        function callCSPAPI(tickers, loadingMessage, useWatchlist = false) {
            const container = document.getElementById('cspRecommendations');
            const loading = document.getElementById('cspLoading');
            const table = document.getElementById('cspTable');
            
            // Show loading state
            container.style.display = 'block';
            loading.style.display = 'block';
            table.style.display = 'none';
            
            // Update loading message
            const loadingText = loading.querySelector('p');
            if (loadingText) {
                loadingText.textContent = loadingMessage;
            }
            
            // Prepare request data
            const requestData = {
                tickers: tickers,
                use_watchlist: useWatchlist
            };
            
            // Make API call
            fetch('/api/options/recommendations/cash-secured-puts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('CSP API Response:', data);
                loading.style.display = 'none';
                
                if (data.error) {
                    console.error('CSP API Error:', data.error);
                    showError(data.error);
                    return;
                }
                
                if (data.recommendations && data.recommendations.length > 0) {
                    console.log(`Displaying ${data.recommendations.length} CSP recommendations`);
                    displayCSPRecommendations(data.recommendations, data.total_considered || data.recommendations.length);
                    table.style.display = 'block';
                } else {
                    console.log('No CSP recommendations found');
                    showInfo('No cash secured put opportunities found for the provided tickers');
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                console.error('Error loading CSP recommendations:', error);
                showError('Failed to load CSP recommendations');
            });
        }

        let cspExpandedRows = new Set();

        function displayCSPRecommendations(recommendations, totalConsidered = recommendations.length) {
            console.log('displayCSPRecommendations called with:', recommendations.length, 'recommendations');
            console.log('First recommendation:', recommendations[0]);
            
            const tbody = document.getElementById('cspTableBody');
            const tableInfo = document.getElementById('cspTableInfo');
            tbody.innerHTML = '';
            cspExpandedRows.clear();
            
            // Store recommendations for expansion
            window.cspRecommendations = recommendations;
            
            // Update table info
            tableInfo.textContent = `Top ${recommendations.length} cash secured put opportunities (from ${totalConsidered} analyzed) - click any row to expand details`;
            
            // ULTRA SIMPLE VERSION - Just show ticker name first
            recommendations.forEach((rec, index) => {
                console.log(`Processing recommendation ${index}:`, rec.ticker);
                
                // Create a simple row with just ticker
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${rec.ticker}</td>
                    <td>TEST</td>
                `;
                tbody.appendChild(row);
            });
        }

        function toggleCSPRowExpansion(index) {
            console.log('toggleCSPRowExpansion called for index:', index);
        }

        function selectCSPRecommendation(ticker, strike, expiration, premium) {
            console.log('selectCSPRecommendation called:', ticker, strike, expiration, premium);
        }
    </script>
</body>
</html>
